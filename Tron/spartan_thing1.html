
<!DOCTYPE html>
<html>
<head>
<style>
body
{
background-color: black
}
#winmessage
{
position: absolute;
top: 60px;
left: 650px;
color: Lime;
}
#instructions
{
position: absolute;
top: 50px;
left: 350px;
//color: Lime;
width: 350px;
height: 230px;
//background-color: chocolate;
background-color: #996633;
padding: 10px;
border: 5px solid blue;
}
canvas
{
position: absolute;
top: 0px;
left: 0px;
/* -webkit-filter: blur(2px); */
}


.mission
{
position: absolute;
top: 0px;
left: 100px;
font: bold 200% Consolas, Monaco monospace;
color: white;
background:
 url('https://upload.wikimedia.org/wikipedia/en/f/f0/Transformers,_Fall_of_Cybertron_PC_box_art.jpg') ;
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;



border-right: .1em solid;
width: 16.5em; /* fallback */
width: 17ch; /* # of chars */
margin: 2em 1em;
 white-space: nowrap; 
overflow: hidden;
animation: typing 3s steps(17, end), /* # of steps = # of chars */
          blink-caret .5s step-end infinite alternate;
z-index: -2;
}

@keyframes typing { from { width: 0; } }
@keyframes blink-caret { 50% { border-color: transparent; } }

}
#blurstuff
{
position: absolute;
top:0 px;
left: 0px;
height: 500px;
width: 500px;
z-index: 10;

}

</style>
</head>
<body>

<div id="winmessage"></div>
<canvas id="canvas" ></canvas>
<canvas id="canvas2" ></canvas>
<canvas id="canvas3" ></canvas>
<div id="instructions" ><font color="Lime">Use A to move left, D to move right, and W to jump gravity. Use M to fire laser and N to throw grenade. Press N and S to throw grenade at a lower height. Use H to toggle grappling hook.  There are </font><font color="#00ffff">energy pickups </font><font color="Lime">in the form of blue cubes.  The </font><font color="#dd99ff">enemies</font><font color="lime"> will respawn.  There is a </font><font color="#33cc33">green square-shaped healing bot</font><font color="lime"> that will heal you once you have activated its control point. The astros, the green aliens, and the brown-armored soldiers are your allies.  The purple aliens are the antagonists.  The purple Alien Warrior will boost the attack of all purple aliens touching its red power shield.  Use U to toggle player invisibility.  Press P to toggle menu visibility. Enjoy the game!</font></div>

<div id ="mission" ></div>
<div id="blurstuff"></div>
</body>
<script>
(function(){
var canvas = document.getElementById("canvas"); // the canvas where game will //be drawn
var canvas2 = document.getElementById("canvas2");
var canvas3 = document.getElementById("canvas3");
var context = canvas.getContext("2d"); // canvas context
var context2 = canvas2.getContext("2d");
var context3 = canvas3.getContext("2d");
canvas2.width = 500;
canvas2.height = 500;
canvas3.width = 500;
canvas3.height = 500;
var levelCols=150;	// level width, in tiles
var levelRows=15;	// level height, in tiles
var tileSize=32;	// tile size, in pixels
var enemyWidth = 24;
var enemyHeight = 24;
var playerCol=5; // player starting column
var playerRow=4; // player starting row
var playerSize=24; // player size
var playerdirection = "right";
var playercover = "activated";
var alienCol=20;
var alienRow=6;
var sizeDiff=tileSize-playerSize; // difference between player and tile size
var leftPressed=false; // are we pressing LEFT arrow key?
var rightPressed=false; // are we pressing RIGHT arrow key?
var upPressed=false; // are we pressing UP arrow key?
var downPressed=false; // are we pressing DOWN arrow key?
var mkeypressed=false;
var nkeypressed = false;
var movementSpeed=3; // the speed we are going to move, in pixels per frame
var playerXSpeed=0; // player horizontal speed, in pixels per frame
var playerYSpeed=0; // player vertical speed, in pixels per frame


var gravityForce=0.5; // gravity acceleration, in pixels per frame per frame
var maxFallingSpeed=5; // maximum falling speed
var playerlasersTotal = 5;
var playerlasers = [];
var lasercount = 0;
var playerArmor = 100;
var playerShields = 50;
var playerShieldsstatus = "notcharging";
var floatingenergy = 1;
var energycubes = [[150, 350, 350], [75,150, 150],[200,150, 150 ], [235,150, 150 ],[560,150, 150 ] ];
var enemylasersTotal = 5;
var enemylasers = [];
var enemylasercount = 0;
var enemystatus = "patrollingforaliens";
var enemystatus3 = "sentry";
var enemystatus2 = "not at wall";
var enemyArmor = 50;
var enemyXSpeed = 0;
var enemyYSpeed = 0;
var gravityForce1 = 0.5;
var gravitycount = 0;
var platformXPos = 300;
var platformYPos = 450;
var platformXPos1 = 0;
var platformYPos1 = 0;
var ramps = [];
//for (h = 0; h < 450*0.5; h++)
//{
//ramps.push( [235+ (h*1), 235 - (h*0.5)] );
//}

for (a=3; a < 250*0.5; a++)
{
ramps.push( [1800+ (a*1), 424 - (a*0.75)] );
}

var platformWidth = 200;
var platformHeight = 5;
var platformXSpeed = 0;
var alienstatus = "guarding";
var lightXPos = 0;
var lightYPos = 0;
var lightstatus = "at alien";
var hitarray = [];
var hitarray2 = [];
var hitarray3 = [];
var hitarray4 = [];
var clouds = [];

var vehicleXPos = 1200;
var vehicleYPos = 100;
var vehicle2XPos = 1000;
var vehicle2YPos = 200;
var planeXSpeed = 0;
var planeYSpeed = 0;
var enemiesTotal = 20; /* total number of enemies to start with in game */
var numberofenemies = 0;
var enemies = []; /* array containing enemies */
var spawnenemy = "inactive"; /*not spawning enemies yet */
var enemylasersTotal = 5; /* how many lasers each enemy has */
var plane2XSpeed = 0;
var plane2YSpeed = 0;
var plane2Rotation = 0;
var plane2RotationSpeed = 0;
var offsetX = 0;
var offsetY = 0;
var offsetXstate = 1;
var offsetYstate = 1;
var offsetXamount = 0;
var offsetYamount = 0;
var controlpoints= [];
var numberofcontrolpoints = 3;
var playergrenades = [];
var grenadecount = 0;
var playerstealth="uncloaked";
var stealthcount = 0;

var playerImage = new Image();
playerImage.src="http://image.wikifoundry.com/image/3/747e36b279a5e379781936bd59290bb8";
var playerImage2 = new Image();
playerImage2.src="http://image.wikifoundry.com/image/3/3fbe3c762d02380c2893794a17ff3328";
var allyImage = new Image();
allyImage.src = "http://image.wikifoundry.com/image/3/d1e8f40c9dfab547f638df4f0395b288";
var allyImage2 = new Image();
allyImage2.src="http://image.wikifoundry.com/image/3/01aace45f77a11b5599fa795c01f9a59";
var enemyImage = new Image();
enemyImage.src="http://image.wikifoundry.com/image/3/31197b1923980da5e257c317532de7b0";
var enemyImage2 = new Image();
enemyImage2.src="http://image.wikifoundry.com/image/3/2c3eab08eb04cbba8ebc0338322f9dfe";
var laserblasterImage = new Image();
laserblasterImage.src="http://image.wikifoundry.com/image/3/a2390bac8e5172d72c81d2b73848a36b";
var laser1Image = new Image();
laser1Image.src="http://image.wikifoundry.com/image/3/fbd4bf702ecd3304ba762f0e7537a6c5";
var laser2Image = new Image();
laser2Image.src="http://image.wikifoundry.com/image/3/6aabf5ed188d138315e631759923ee4e";
var laser3Image = new Image();
laser3Image.src ="http://image.wikifoundry.com/image/3/d4e0f24142180e6a990207f994d4b593";
var laser4Image = new Image();
laser4Image.src = "http://image.wikifoundry.com/image/3/130c111322317a2ebd234c5358e6d53e";
var laser5Image = new Image();
laser5Image.src = "http://image.wikifoundry.com/image/3/549c02dc9586199e1a6c91bc77dd6e3b";
var flareImage = new Image();
flareImage.src="http://image.wikifoundry.com/image/3/8d1400eccf87857db815fd18b6e48459";
var vehicleImage = new Image();
vehicleImage.src="http://image.wikifoundry.com/image/3/7d8dd60d57d9f8639f83c69c092ccd4a";
var tireImage = new Image();
tireImage.src = "http://image.wikifoundry.com/image/3/c9e736f0b7bb555195b87c6f3feae383";

var cornertile1 = new Image();
cornertile1.src="http://image.wikifoundry.com/image/3/7d26f274052fe32a68dc22e94e2e0306";
var cornertile2 = new Image();
cornertile2.src="http://image.wikifoundry.com/image/3/c6841765f77aeb299769e6449f568565";
var groundtile = new Image();
groundtile.src="http://image.wikifoundry.com/image/3/98a05cd6e79cfc70f40a91f9a31091f5";
var groundtile2 = new Image();
groundtile2.src="http://image.wikifoundry.com/image/3/45be380e8c78c7a033f082e4687c3cc7";

var vehiclestation1 = new Image();
vehiclestation1.src="http://image.wikifoundry.com/image/3/a126289777eb57f1c4671cb862d4eb7d";

var theme1 =  new Audio("http://legoattachments3.pbworks.com/w/file/fetch/97642362/Halo%203%20Original%20Soundtrack%20%28The%20Covenant%20%20One%20Final%20Effort%29.mp3");
theme1.volume = 0.5;
theme1.load();

//var theme2 =  new //Audio("http://legoattachments3.pbworks.com/w/file/fetch/97765764/soundtrac
//k1.mp3");
//theme2.volume = 0.3;
//theme2.load();

var tformerssong = new Audio("http://wikifoundryattachments.com/X_j5okKZD3tPYjGkePBz_g2081480");
tformerssong.volume=0.5;
tformerssong.load();

//var blastersound = new Audio("
//http://wikifoundryattachments.com/VXk1PUjXbOdu6KpfQrNPkw85419
//");
//blastersound.volume= 0.1;
//blastersound.load();

//var nadesound = new Audio("http://wikifoundryattachments.com/MUUpibBN0jkIGCH4DalWlw114258");

//nadesound.volume=0.1;
//nadesound.load();






var nadesounds = [];


			for (var i = 0; i < 20; i++) {
				// Initalize the object
				var nadesound = new Audio("http://wikifoundryattachments.com/MUUpibBN0jkIGCH4DalWlw114258");
				nadesound.volume = 0.5;
				nadesound.load();
				nadesounds[i] = nadesound;
			}
	var currSound = 0;

function playnadesound() {
if (nadesounds[currSound])
{
		if(nadesounds[currSound].currentTime == 0 || nadesounds[currSound].ended) {
			nadesounds[currSound].play();
			nadesounds[currSound].currentTime = 1;
		}
		currSound = (currSound + 1) % 20;
}	
}

var lasersounds = [];
for (var i = 0; i < 50; i++) {
				// Initalize the object
				var lasersound = new Audio("http://wikifoundryattachments.com/VXk1PUjXbOdu6KpfQrNPkw85419");
				lasersound.volume = 0.5;
				lasersound.load();
				lasersounds[i] = lasersound;
			}
	var currSound2 = 0;

function playlasersound() {
if (lasersounds[currSound2])
{
		if(lasersounds[currSound2].currentTime == 0 || lasersounds[currSound].currentTime == 1) {
lasersounds[currSound2].currentTime = 0;
			lasersounds[currSound2].play();


		}
		currSound2 = (currSound2 + 1) % 50;
}	
}
var aliensounds = [];
for (var i = 0; i < 10; i++) {
				// Initalize the object
				var aliensound = new Audio("http://wikifoundryattachments.com/JkUWVOy0QC1XfALUEkyFlQ17712");
				aliensound.volume = 0.1;
				aliensound.load();
				aliensounds[i] = aliensound;
			}
	var currSound3 = 0;

function playaliensound() {
if (aliensounds[currSound3])
{
		if(aliensounds[currSound3].currentTime == 0 || aliensounds[currSound3].ended) {

			aliensounds[currSound3].play();


		}
		currSound3 = (currSound3 + 1) % 10;
}	
}


var energycubesounds = [];
for (var i = 0; i < 2; i++) {
				// Initalize the object
				var energycubesound = new Audio("http://wikifoundryattachments.com/-gdxuyqkyIzUjPsQ6iIUwA100884");
				energycubesound.volume = 0.1;
				energycubesound.load();
				energycubesounds[i] = energycubesound;
			}
	var currSound4 = 0;

function playenergycubesound() {
if (energycubesounds[currSound4])
{
		if(energycubesounds[currSound4].currentTime == 0 || energycubesounds[currSound4].ended) {

			energycubesounds[currSound4].play();


		}
		currSound4 = (currSound4 + 1) % 2;
}	
}

var astrowalksounds = [];
for (var i = 0; i < 5; i++) {
				// Initalize the object
				var astrowalksound = new Audio("http://wikifoundryattachments.com/sLOZVSxcUkxUuV6S8qm1Ug483192");
				astrowalksound.volume = 0.1;
				astrowalksound.load();
				astrowalksounds[i] = astrowalksound;
			}
	var currSound5 = 0;

function playastrowalksound() {
if (astrowalksounds[currSound5])
{
		if(astrowalksounds[currSound5].currentTime == 0 || astrowalksounds[currSound5].ended) {
astrowalksounds[currSound5].currentTime=3;
			astrowalksounds[currSound5].play();


		}
		currSound5 = (currSound5 + 1) % 5;
}	
}

var landsounds = [];
for (var i = 0; i < 5; i++) {
				// Initalize the object
				var landsound = new Audio("http://wikifoundryattachments.com/tnkMSH7YtYWL0z6aPCdOjw45715");
				landsound.volume = 0.1;
				landsound.load();
				landsounds[i] = landsound;
			}
/*
	var currSound6 = 0;

function playlandsound() {
if (landsounds[currSound6])
{
		if(landsounds[currSound6].currentTime == 0 || landsounds[currSound6].ended) {
landsounds[currSound6].currentTime=1.2;
landsounds[currSound6].volume=0.05;
			landsounds[currSound6].play();


		}
		currSound6 = (currSound6 + 1) % 5;
}	
}
*/
var rogersounds = [];
for (var i = 0; i < 5; i++) {
				// Initalize the object
				var rogersound = new Audio("http://wikifoundryattachments.com/_9xX8PQLjeKK5C8Q0ilqdA97542");
				rogersound.volume = 1;
				rogersound.load();
				rogersounds[i] = rogersound;
			}
	var currSound7 = 0;

function playrogersound() {
if (rogersounds[currSound7])
{
		if(rogersounds[currSound7].currentTime == 0 || rogersounds[currSound7].ended) {
rogersounds[currSound7].currentTime=0;
rogersounds[currSound7].volume=1;
			rogersounds[currSound7].play();


		}
		currSound7 = (currSound7 + 1) % 5;
}	
}


var volumestuff = 0;

//add new image stuff

var playerwalkcycle = new Image();
playerwalkcycle.src="http://image.wikifoundry.com/image/3/83e9c2428cfc2516440bb1311a5f4b4c";

var playerwalkcycle2 = new Image();
playerwalkcycle2.src="http://image.wikifoundry.com/image/3/5e7c6d73d19cdb5ed057f121616ca350";

var alienwalkcycle = new Image();
alienwalkcycle.src="http://image.wikifoundry.com/image/3/130b06b099d463c8c064ebb5dbc115f2";

var alienwalkcycle2 = new Image();
alienwalkcycle2.src="http://image.wikifoundry.com/image/3/8bd099167415f6a705aa98a83b29fdb2";

var blasterimage = new Image();
blasterimage.src="http://image.wikifoundry.com/image/3/55d8993941e90e13fd87f89ffc5117d2";

var blastercount = 0;

//var shieldimage = new Image();
//shieldimage.src="http://image.wikifoundry.com/image/3/28e6be0c0383611188//40bda83e3271d2";


var laserimagestatus = 10;
var numberofallies = 0; /* number of allies at start */
var allies = [];
var allyWidth = 24;
var allyHeight = 24;

var numberofaliens = 0;
var aliens = [];

var laserWidth = 50;
var laserHeight = 5;
var instructionsvisibility = "visible";
var pkeypressed = false;
var pausecount = 0;
var skeypressed = false;
var XPos1 = 0;
var ukeypressed = false;
var jkeypressed = false;
var cannonX = 2050;
var cannonY = 250;
var cannonXPos1 = 0;
var cannonvar1 = 0;
var cannonvar2 = 0;
var cannonRotation = 0;
var cannonarray = [];
var planeRotation = 0;
var plane3XPos = 300;
var plane3YPos = 390;
var gravityvalue = 0;
var plane3XSpeed = 0;
var plane3YSpeed = 0;
var lift = 0;
var thrust = 0;
var forwardSpeed = 0;
var elevatorForce = 0;
var elevatorForceX = 0;
var elevatorForceY = 0;
var forceX = 0;
var forceY = 0;
var sparkarray = [];
var sparkcount = 0;
var vehicle = [
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0],
[0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
[0,0,0,2,2,2,1,4,4,4,4,4,4,1,1,1,1,1,1,1,1,1,1,1,0],
[0,0,2,2,2,1,1,1,3,1,1,3,1,1,1,1,1,1,1,1,1,1,1,0,0],
[0,1,1,1,1,1,1,1,3,1,1,3,1,1,1,1,1,1,1,1,1,1,0,0,0],
[0,1,1,1,1,1,1,4,4,4,4,4,4,1,1,1,1,1,1,1,0,0,0,0,0],
[0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0]
];
var vehicle2 = [
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],
[0,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
[0,2,2,2,1,1,1,1,1,1,1,1,1,1,1,3,3,1,0,0],
[1,1,1,1,1,1,1,3,3,3,3,3,1,1,1,1,1,0,0,0],
[1,1,1,1,1,1,1,1,4,4,1,1,1,1,0,0,0,0,0,0]
];
var level = [ 
// the 50x15 level - 1=wall, 0=empty space
[2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[2,2,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],
[2,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,1,1,1,4,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,1],
[2,0,3,1,1,1,1,1,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,0,0,0,0,0,0,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,2,2,2.3,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,1],
[2,1,0,0,0,0,0,0,0,0,0,0,0,0,3,2,2,0,0,3,1,4,0,0,3,1,1,1,1,4,0,0,0,3,1,1,1,1,1,1,1,1,1,0,0,1,1,1,2,2,0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
[2,2,1,1,1,1,1,1,4,0,0,0,3,1,2,2,2,1,1,2,2,2,1,1,2,2,2,2,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
[2,2,2,2,2,2,2,2,2,0,0,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0,0,1,0,3,2,2,2,2,2,2,2,2,2,2,2,0,0,2,2,2,2,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,3,0,0,0,1,3,4,4,4,3,0,0,0,0,0,0,0,0,1],
[2,0,0,0,0,0,0,3,1,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,4,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]];

var obstaclelevel = [ // obstacle layer
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]	,
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
];
var winlevel = [ // obstacle layer
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]	,
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
];
var lasers = [
[ 0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ],
[ 0,0,0,0,0,0,1,2,2,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ],
[ 0,0,0,0,0,1,2,3,3,3,3,2,2,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ],
[ 0,0,0,0,1,2,3,4,4,4,4,3,3,2,2,2,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ],
[ 0,0,0,1,2,3,4,5,5,5,5,4,4,3,3,3,2,2,2,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ],
[ 0,0,1,2,3,4,5,6,6,6,6,5,5,4,4,4,3,3,3,2,2,2,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0 ],
[ 0,1,2,3,4,5,6,7,7,7,7,6,6,5,5,5,4,4,4,3,3,3,2,2,2,1,1,1,1,0,0,0,0,0,0,0,0,0 ],
[ 1,2,3,4,5,6,7,7,7,7,7,7,7,6,6,6,5,5,5,4,4,4,3,3,3,2,2,2,2,1,1,1,0,0,0,0,0,0 ],
[ 1,3,4,5,6,7,7,7,7,7,7,7,7,7,7,7,6,6,6,5,5,5,4,4,4,3,3,3,3,2,2,2,1,1,1,0,0,0 ],
[ 1,3,4,5,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,6,6,6,4,4,4,4,3,3,3,2,2,2,1,1,1 ],
[ 1,3,4,5,6,7,7,7,7,7,7,7,7,7,7,7,6,6,6,5,5,5,4,4,4,3,3,3,3,2,2,2,1,1,1,0,0,0 ],
[ 1,2,3,4,5,6,7,7,7,7,7,7,7,6,6,6,5,5,5,4,4,4,3,3,3,2,2,2,2,1,1,1,0,0,0,0,0,0 ],
[ 0,1,2,3,4,5,6,7,7,7,7,6,6,5,5,5,4,4,4,3,3,3,2,2,2,1,1,1,1,0,0,0,0,0,0,0,0,0 ],
[ 0,0,1,2,3,4,5,6,6,6,6,5,5,4,4,4,3,3,3,2,2,2,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0 ],
[ 0,0,0,1,2,3,4,5,5,5,5,4,4,3,3,3,2,2,2,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ],
[ 0,0,0,0,1,2,3,4,4,4,4,3,3,2,2,2,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ],
[ 0,0,0,0,0,1,2,3,3,3,3,2,2,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ],
[ 0,0,0,0,0,0,1,2,2,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ],
[ 0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ]
];

//add new vars

var alienguardX = 1560 , 
alienguardY = 145;

var teleported = "false";

var grapplinghook = "notused",
gX,
gY,
gXs = 0,
gYs = 0,
gC = 90,
gCs = 2,
gCr = "notready",
gCa = 0.5;

var squadbehavior = "tacticalmaneuver";

var guards = [];
for ( var i = 0; i < 5; i++)
{
guards.push([2000 + 30*i, 50, "sentry", 25, 0, 0, [], 0, 0, 0, "right", "aliensoldier"]);
}

var br = 0,
br2 = 3,
br3 = 3,
br4 = 0,
br5  = 0;

var a2 = 0,
a3 = 0;

var astroguardL = 0;
var astroguard2L = 0;

var laserexplosions = [];

var glassarray = [],
glassalpha = 0.5;

var jumpvar = 0,
j3 = 0,
j2 = 0,
j4 = 0,
jumpvar2 = 3;

var s1 = 0,
s2 = 0;

var warriors = [
[860, 192, "kneel" , 5, 0, 0, 0, 0, 0, 0, 0, 0, 3], 
[780, 190, "scanning" , 0, 0, 0, 0, 0, 0, 0, 0, 0, 3],
[810, 185, "lesstactical" , 10, 0, 0, 0, 0, 0, 0, 0, 0, 3] 
];

var warriorlasers = []; 

var warriorX = 700;
var warriorY = 180;
var ws = "kneel";
var warriorL = 0;
var warriorR = 0;
var wlo = 0;
var wloy = 0;




var pulselaserC = 0;

var turretX = 100;
var turretY = 200;
var turretR = -5;
var turretstatus = 0;
var turretfirerate = 0;
var turretfiring = 0;


var beaconarray = [];

var alienroles = 0; 
var alienleaderchosen = 0;

var flarearray = [];

var medichere = "inactive";

var arcrotation = 0;
var greenbox = 1;
var greenbox2 = 0.1;

allyspawncount = 0;

var healingprogress = 0;
var healingparticles = [];
var healingparticles2 = [];

var playerwalk = 0;

var alienshipXPos = 1800;
var alienshipYPos = 100;
var alienshipXSpeed = 2;
var shipparts = 
[[0,48,110, 15, "purple"], 
[100,55,5, 45, "gray"],
[0,55,5, 45, "gray"],
[105,50,20, 40, "purple"],
[125,70,20, 20, "purple"],
[125,60,20, 10, "#33CCFF"],
[20, 100, 50, 5, "gray"]
 ];

var ship2parts = 
[[0, 0, 200, 10, "green"],
[195, 0, 80, 80, "green"],
[50, 70, 180, 10, "green"],
[250, 10, 50, 35, "#33CCFF"],
[195, 30, 100, 30, "green"],
[50, 50, 10, 40, "green"]
];

astroship2XPos = 2100;
astroship2YPos = 80;
astroship2XSpeed = 2;

var laserSize = 2;
var laserX = 100;
var laserY = 150;
var lightImage = new Image();
lightImage.src = "http://i.stack.imgur.com/fzXf8.png";
//lightImage.src = //"http://image.wikifoundry.com/image/3/88439e1472c145ebc3e266611fbdf722";
//lightImage.src="http://image.wikifoundry.com/image/3/a2568fdb3529363bdc7eaa//550b5f0b7a";
//lightImage.src="http://image.wikifoundry.com/image/3/129c299adbf0898bcad5e7//a77e7da403";
var lightImage2 = new Image();
lightImage2.src="http://image.wikifoundry.com/image/3/cdc9f440aba05b3af84ccc700ab3dc99";
var lightImage2count = 0;
var lightImage2count1 = 0;
var lightImage2progress = 1;
var panelImage = new Image();
panelImage.src="http://image.wikifoundry.com/image/3/f52c48587f79a449229b868c12a11472";
var var1 = -10;
var var2 = 0;
var notinplane = 1;
var mechImage = new Image();
mechImage.src="http://image.wikifoundry.com/image/3/d18f14e141b00bf756469705e18b5920";
var mechXPos = 1500;
var mechYPos = 350;
var mechXSpeed = 1;
var mechXPos1 = 0;
var mechXPos2 = 0;
var mechDirection = "right";
var consoleImage = new Image();
consoleImage.src="http://image.wikifoundry.com/image/3/844c21165f83f14ae6e2cb62774e86fa";
var glowImage = new Image();
glowImage.src= "http://image.wikifoundry.com/image/3/14b4fbf83c2747db5faaacfbf5885068";
var glowArray = [];
var numberofglowParticles = 30;
var VehicleImage = new Image();
VehicleImage.src="http://image.wikifoundry.com/image/3/59f3182c3e8da80e4394daf23ad05207";

var alienstuff = new Image();
alienstuff.src="http://image.wikifoundry.com/image/3/09492c77ad48445773e4062e61c1aeda";
var alienstuff2 = new Image();
alienstuff2.src="http://image.wikifoundry.com/image/3/b2ff73ab2c434567bbc780b029ed018a";

var alienjumping = new Image();
alienjumping.src="http://image.wikifoundry.com/image/3/8170c06261660551a1d938a4d7a240ea";

var laserexplosion = new Image();
laserexplosion.src="http://image.wikifoundry.com/image/3/4243c607a80a3c10151c586b085050a6";

var astroguard = new Image();
astroguard.src="http://image.wikifoundry.com/image/3/961aa28367ccaa5566036a8923f5bf2b";

var astroguard2 = new Image();
astroguard2.src="http://image.wikifoundry.com/image/3/b601968bcca22f9914961b974da8136c";

var astroguard2laser = new Image();
astroguard2laser.src="http://image.wikifoundry.com/image/3/7d8af59a0d587eb4c14213156f984153";

var alienguard = new Image();
alienguard.src="http://image.wikifoundry.com/image/3/612577811f4aa0609a0bc028a85d5fa8";

var jetpacking = new Image();
jetpacking.src="http://image.wikifoundry.com/image/3/83af562d45552cbf06b4e443beba0974";

var jetpackingL = 0;

var alienguardL = 0;

var guardlasers = [];
var guardlasercount = 0;

var fps = {
startTime : 0,
frameNumber : 0,
getFPS : function(){
this.frameNumber++;
var d = new Date().getTime(),
currentTime = ( d - this.startTime ) / 1000,
result = Math.floor( ( this.frameNumber / currentTime ) );
if( currentTime > 1 ){
this.startTime = new Date().getTime();
this.frameNumber = 0;
}
return result;
}
};
// water variables
var waterPosition = 0,
waterVelocity = 0,
waterAcceleration = 0;
//k = "0.25f";
// x = height - targetHeight, acce;eratiom = -k *x
// a = -(k/m)x - dv
// d= dampening factor
/*
for ( var i = 0; i < springs.length; i++ )
{
springs pull on the springs next to them
}
splash function: changes velocity of a spring
draw trapezoids
*/
//waterPosition += waterVelocity
//waterVelocity += waterAcceleration

var terPoints = terrain(3000, 800, 200/4, 0.7);
function terrain(width, height, displace, roughness){
var points = [],
// Gives us a power of 2 based on our width
power = Math.pow(2, Math.ceil(Math.log(width) / (Math.log(2))));
// Set the initial left point
points[0] = height/2 + (Math.random()*displace*2) - displace;
// set the initial right point
points[power] = height/2 + (Math.random()*displace*2) - displace;
displace *= roughness;
// Increase the number of segments
for(var i = 1; i < power; i *=2){
// Iterate through each segment calculating the center point
for(var j = (power/i)/2; j < power; j+= power/i){
points[j] = ((points[j - (power / i) / 2] + points[j + (power / i) / 2]) / 2);
points[j] += (Math.random()*displace*2) - displace
}
// reduce our random range
displace *= roughness;
}
return points;
}
var vehicle1XPos = 400;
var vehicle1YPos = 250;
var vehicle1XSpeed = 0;
var vehicle1XAcceleration = 0;
var vehicle1YSpeed = 0;
var vehicle1Rotation = 0;
var vehicle1XPos1 = 450;
var vehicle1YPos1 = 250;
var vehicle1XSpeed1 = 0;
var vehicle1YSpeed1 = 0;
var vehicle1Rotation12 = 0;
var stretchamount = 0;
var stretchspeed = 0;
var stretchamount2 = 0;
var stretchspeed2 = 0;
var vehicle1w1force = 0;
var vehicle1w2force = 0;
// circle for test
var circle = {
x: 80,
y: 50,
r: 5,
YSpeed: 0
};
var rectangle = {
x: 50,
y: 200,
w: 50,
h: 50
};
function circleRecttouching(circle, rect)
{
var distX= Math.abs( circle.x - rect.x - rect.w/2);
var distY = Math.abs( circle.y - rect.y - rect.h/2);
if ( distX > (rect.w/2 + circle.r))
{
return false;
}
if ( distY > ( rect.h/2 + circle.r))
{
return false;
}
if ( distX <= ( rect.w/2))
{
return true;
}
if ( distY <= ( rect.h/2))
{
return true;
}
var dx = distX - rect.w/2;
var dy = distY - rect.h/2;
return ( dx* dx + dy*dy <= (circle.r * circle.r));
}
var playerYPos=playerRow*tileSize+sizeDiff/2;	// converting Y player position from tiles to pixels
var playerXPos=playerCol*tileSize+sizeDiff/2; // converting X player position from tiles to pixels
var alienYPos=alienRow*tileSize+sizeDiff/2;
var alienXPos=alienCol*tileSize+sizeDiff/2;
var enemyYPos = 5*tileSize+sizeDiff/2;
var enemyXPos = 20*tileSize+sizeDiff/2;
canvas.width= 500; // canvas width. Won't work without it even if you style it from CSS

var gCy = 0;


// I changed canvas width from 1000 to 500
canvas.height=600; // canvas height. Same as before
document.addEventListener("keydown", function(ev){
switch(ev.keyCode){
case 65:
leftPressed=true;
break;
case 77:
mkeypressed=true;
break;
case 78:
nkeypressed = true;
break;
case 80:
pkeypressed = true;
break;
case 83:
skeypressed = true;
break;
case 72:
//again, it's actually the h key
jkeypressed = true;

break;
case 85:
ukeypressed = true;
break;
case 87:
// this time we reverse gravity if the player is on the floor
upPressed=true;
//if(playerYSpeed <=0){
//playerYSpeed= -15;
//playerYSpeed = -12;
//}
break;
case 68:
rightPressed=true;
break;
case 83:
downPressed=true;
break;
case 82:
rkeypressed = true;
break;

}
}, false);
document.addEventListener("keyup", function(ev){
switch(ev.keyCode){
case 65:
leftPressed=false;
break;
case 77:
mkeypressed=false;
break;
case 78:
nkeypressed = false;
break;
case 80:
pkeypressed = false;
break;
case 83:
skeypressed = false;
break;
case 85:
ukeypressed = false;
break;
case 72:
//it's actually the h key
jkeypressed = false;

break;
case 87:
upPressed=false;
break;
case 68:
rightPressed=false;
break;
case 83:
downPressed=false;
break;
case 82:
rkeypressed = false;
break;
}
}, false);
// function to display the level
function renderLevel(){
// clear the canvas
if ( notinplane == 1)
{
context.clearRect(playerXPos-1000, playerYPos -500, playerXPos + 1900,
playerYPos + 800);
}
else if ( notinplane == 2)
{
context.clearRect(plane3XPos-300, plane3YPos-300, 1000, 1000);
}

context.translate( offsetX, offsetY);

context2.clearRect( 0, 0, 1000, 1000);
context2.translate( offsetX, offsetY);
//if ( playerlasers.length > 0 )
//{
//context.globalCompositeOperation = "lighter";
//}
//else if ( playerlasers.length <= 0)
//{
//context.globalCompositeOperation = "normal";
//}

// drawing terrain


//context.fillStyle="rgb(153, 80, 6)";
context.fillStyle="#996633";
// draw the points
context.beginPath();
context.moveTo(0, terPoints[0]);
for (var t = 1; t < terPoints.length; t++)
{
context.lineTo(t, terPoints[t]);
}
// finish creating the rect so we can fill it
context.lineTo(canvas.width+50, canvas.height-100);
context.lineTo(0, canvas.height-100);
context.closePath();
context.fill();

var length1 = (vehicle1XPos+vehicle1XPos1)/2;

context.save();
context.translate( length1-5, (vehicle1YPos+vehicle1YPos1)/2 -5 );
context.rotate(rad3);
context.drawImage( allyImage, -24/2 - 5, -24/2 - 5, 24, 24);
context.restore();



context.save();
var rad3 = (Math.asin( (-(vehicle1YPos+stretchamount) + vehicle1YPos1+ stretchamount2)/ 100));
context.translate( length1-5, (vehicle1YPos+vehicle1YPos1)/2 -5 );
context.rotate(rad3);
context.drawImage( VehicleImage, -50/2, -15/2, 50, 15);
//context.fillRect(-50/2, -10/2, 50, 10);


context.restore();


context.save();
context.translate( vehicle1XPos, vehicle1YPos);

var vehicle1Rotation1 = vehicle1Rotation*Math.PI/180;
context.rotate( vehicle1Rotation1);

context.fillStyle="yellow";
//context.fillRect( -100/2, -20/2 , 100, 20);
//context.beginPath();
//context.arc( 0, 0, 5, 0, 2*Math.PI);
//context.stroke();
//context.fill();
context.drawImage(tireImage, -25/2, -25/2, 25, 25);
context.restore();
context.save();
context.translate( vehicle1XPos1, vehicle1YPos1);
var vehicle1Rotation2 = vehicle1Rotation12*Math.PI/180;
context.rotate( vehicle1Rotation2);
context.fillStyle="yellow";
//context.fillRect( -100/2, -20/2 , 100, 20);
//context.beginPath();
//context.arc( 0, 0, 5, 0, 2*Math.PI);
//context.stroke();
//context.fill();
context.drawImage(tireImage, -25/2, -25/2, 25, 25);
context.restore();
//context.beginPath();
//context.moveTo( vehicle1XPos, vehicle1YPos);
//context.lineTo( vehicle1XPos1, vehicle1YPos1);
//context.closePath();
//context.stroke();




/*
for (i = 0; i < 8; i++)
{
for (j = 0; j < 30; j++)
{
if ( vehicle[i][j] == 1)
{
context.fillStyle = "#FF0000";
context.fillRect((j*5) +vehicleXPos-150, i*5+ vehicleYPos, 5, 5);
}
if ( vehicle[i][j] == 2)
{
context.fillStyle = "#33CCFF";
context.fillRect((j*5)+vehicleXPos-150, i*5+ vehicleYPos, 5, 5);
}
if ( vehicle[i][j] == 3)
{
context.fillStyle = "#FFCC00";
context.fillRect((j*5) +vehicleXPos-150, i*5+ vehicleYPos, 5, 5);
}
if ( vehicle[i][j] == 4)
{
context.fillStyle = "#CC0000";
context.fillRect((j*5) +vehicleXPos-150, i*5+ vehicleYPos, 5, 5);
}
}
}
*/

context.fillText(vehicle2XPos , 50, 350);
context.fillText(vehicle2YPos, 50, 360);

/*
for (i = 0; i < 5; i++)
{
for (j = 0; j < 20; j++)
{
if ( vehicle2[i][j] == 1)
{
context.fillStyle = "#5C5C5C";
//context.fillRect((j*5) +vehicle2XPos-150, i*5+ vehicle2YPos, 5, 5);
}
if ( vehicle2[i][j] == 2)
{
context.fillStyle = "#33CCFF";
//context.fillRect((j*5)+vehicle2XPos-150, i*5+ vehicle2YPos, 5, 5);
}
if ( vehicle2[i][j] == 3)
{
context.fillStyle = "#777776";
//context.fillRect((j*5) +vehicle2XPos-150, i*5+ vehicle2YPos, 5, 5);
}
if ( vehicle2[i][j] == 4)
{
context.fillStyle = "#006600";
//context.fillRect((j*5) +vehicle2XPos-150, i*5+ vehicle2YPos, 5, 5);
}
}
}
*/

if (playerXPos > 0 && playerXPos < 500)
{
context.drawImage( consoleImage, 63, 140);
}

if (playerXPos > 1500 && playerXPos < 3000)
{
context.drawImage( vehiclestation1, 0, 315, 484, 330, 1800, 160, 484, 330 );
}



// walls = red boxes
//context.fillStyle = "Chocolate";

context.fillStyle = "#5C2E00";

//context.save();
//context.globalAlpha = 0.5;

gX += gXs;
gY += gYs;

gCy += 1;

if ( jkeypressed && gCy > 20 && grapplinghook === "notused" )
{
grapplinghook = "activated";
gCy = 0;
gC = 90;
}
else if ( jkeypressed && gCy > 20 && grapplinghook === "deactivated" )
{
grapplinghook = "notused";
gCr = "notready";
gCy = 0;
gC = 90;
}

if(grapplinghook === "notused")
{
if (playerdirection === "right")
{
gX = playerXPos;
}
else
{
gX = playerXPos + 15
}
gY = playerYPos;
}

if (grapplinghook === "activated")
{
gYs = -5;
}
if (grapplinghook !== "activated" )
{
gYs = 0;
}



if (gC >= 180 && gCs > 0)
{
gCs *= -1;
}
if ( gC <= 0 && gCs <  0)
{
gCs *= -1;
}

for(i=0;i<levelRows;i++){
for(j=0;j<levelCols;j++){

if (level[i][j] !== 0)
{

var baseCol = Math.floor(gX/32);
var baseRow = Math.floor(gY/32);

if ( level[baseRow][baseCol] !== 0 && grapplinghook === "activated" )
{

gXs = 0;
gYs = 0;
gC = 90;
grapplinghook = "deactivated";


}

}

}
}

if ( grapplinghook === "deactivated" &&  gCr === "notready" )
{

playerYSpeed = -2;

}

if ( gCr === "ready")
{
gC += gCs;
//gCs *= 0.9;
playerXPos = gX + Math.cos(gC*Math.PI/180)*50;
playerYPos = gY + Math.sin(gC*Math.PI/180)*50;

}

if ( grapplinghook === "deactivated" && playerYPos == Math.floor(gY + Math.sin(90*Math.PI/180)*50) )
{
gCr = "ready";
} 

for(i=0;i<levelRows;i++){
for(j=0;j<levelCols;j++){
if(level[i][j] >= 1 
&& j*tileSize < playerXPos + 250 && j*tileSize > playerXPos -250){
if ( level[i][j] == 1)
{
//context.drawImage( groundtile, j*tileSize,i*tileSize);
context.fillRect(j*tileSize,i*tileSize,tileSize,tileSize);
}


if ( level[i][j] == 2)
{
context.drawImage( groundtile2, j*tileSize,i*tileSize);
}
if ( level[i][j] == 3)
{
context.drawImage( cornertile1, j*tileSize,i*tileSize);
}
if ( level[i][j] == 4)
{
context.drawImage( cornertile2, j*tileSize,i*tileSize);
}

}
}
}

//context.restore();

//context.fillRect( platformXPos, platformYPos, platformWidth, platformHeight);

context.fillStyle = "cyan";

for (h=0; h < ramps.length; h++)
{
context.fillRect( ramps[h][0], ramps[h][1], 1, 1);
}


if ( lightImage2progress < 60 )
{
context.fillRect( 800, 330, 30, 100);
}

context.save();
context.globalAlpha = 0.5;

context.fillStyle = "Blue";
for(i=0;i<levelRows;i++){
for(j=0;j<levelCols;j++){
if(obstaclelevel[i][j]==1){
context.fillRect(j*tileSize,i*tileSize,tileSize,tileSize);
}
}
}

context.restore();

context.fillStyle = "gold";
for(i=0;i<levelRows;i++){
for(j=0;j<levelCols;j++){
if(winlevel[i][j]==1){
context.fillRect(j*tileSize,i*tileSize,tileSize,tileSize);
}
}
}
// player = green box
for ( i = 0; i < energycubes.length; i++)
{
energycubes[i][1] += Math.sin(floatingenergy/20)/3;
floatingenergy+=1;
context.save();
context.scale(2, 1);
context.beginPath();
context.arc(energycubes[i][0]/2 + 4, energycubes[i][2]+30+70, 5, 2 * Math.PI, false);
context.fillStyle = "rgba(112, 250, 248, " + (1-Math.cos(floatingenergy/20)/2) + ")";
context.fill();
context.restore();
context.fillStyle= "#33CCFF";
context.fillRect( energycubes[i][0], energycubes[i][1]+70, 15, 15);
}
context.fillStyle = "#00ff00";

var baseCol = Math.floor(playerXPos/tileSize);
var baseRow = Math.floor(playerYPos/tileSize);

context.fillText( Math.floor(playerArmor) + ' ' + playerXPos + ' ' + playerYPos + ' ' + stealthcount, playerXPos+ 10, playerYPos - 25);

//if ( cannonarray.length > 0)
//{
//if ( playergrenades.length > 0)
//{
//for ( var i = 0; i < playergrenades.length; i++)
//{
//var grenadeX = Math.floor(playergrenades[i][0]/tileSize);
//var grenadeY = Math.floor(playergrenades[i][1]/tileSize);
//context.fillText( grenadeX+1, playerXPos+i*30, playerYPos - 90);
//}
//}

context.fillText( "framerate: " + fps.getFPS() + " frames per second", playerXPos, playerYPos - 100);

//}
context.fillStyle = "gray";
context.fillRect( playerXPos - 5, playerYPos - 18, 50, 5);
context.fillRect( playerXPos - 5, playerYPos - 23, 50, 5);
context.fillStyle = "#33CCFF";
context.fillRect( playerXPos - 5, playerYPos - 23, playerShields, 5);
context.fillStyle = "#00ff00";
context.fillRect( playerXPos - 5, playerYPos - 18, playerArmor/2, 5);
context.fillStyle = "#00CC00";
context.fillRect(alienXPos, alienYPos, playerSize, playerSize);


for (var i = 0; i < playergrenades.length; i++ )
{

//context.fillText( playergrenades[i][2], playergrenades[i][0], playergrenades[i][1] //-20);

context.fillStyle="yellow";
//if (playergrenades[i][4] > 100 )
{
context.fillStyle="yellow";
}
if ( playergrenades[i][4] < 100)
{
if ( !playergrenades[i][5] )
{
playergrenades[i][5] = 1;
}
playergrenades[i][5] += 1;
if (playergrenades[i][5] >= 10)
{
playergrenades[i][5] = 1;
}
if (playergrenades[i][5] >= 1 && playergrenades[i][5] < 5)
{
context.fillStyle = "yellow";
}
if ( playergrenades[i][5] >= 5 )
{
context.fillstyle = "yellow";
}
}
context.fillRect(playergrenades[i][0], playergrenades[i][1], 10, 10);
}


if ( alienstatus === "healingplayer")
{
context.strokeStyle = "#33CCFF";
context.beginPath();
context.moveTo(alienXPos + 12, alienYPos + 12);
context.lineTo(playerXPos + 10, playerYPos + 10);
context.lineWidth = 5;
context.stroke();
//context.fillStyle = "#00FFFF";
//context.fillRect( lightXPos, lightYPos, 15, 15);





//context.save();


}
else
{
context.lineWidth = 0;
}
if (controlpoints.length > 0)
{
for (var i = 0; i < controlpoints.length; i++)
{
//context.fillStyle="blue";
//context.fillRect( controlpoints[i][0], controlpoints[i][1], 100, 10);
//context.fillStyle = "blue";
//context.fillRect( controlpoints[i][0]+20, controlpoints[i][1] - 35, 100/2, 5);

//context.fillStyle ="cyan";
//context.fillRect( controlpoints[i][0]+20, controlpoints[i][1] - 35, controlpoints[i
//][2]/2, 5);

//context.fillText( controlpoints[i][2], controlpoints[i][0]+ 35, controlpoints[i][1] - 
//50);
}

}



context.fillStyle = "cyan";
for (var i= 0; i < playerlasers.length; i++)
{
context.fillRect(playerlasers[i][0]-2, playerlasers[i][1]-2, playerlasers[i][2]+4, playerlasers[i][3]+4);
}

context.fillStyle = "white";
for (var i= 0; i < playerlasers.length; i++)
{
context.fillRect(playerlasers[i][0], playerlasers[i][1], playerlasers[i][2], playerlasers[i][3]);
}


//context.fillText(offsetX, 50-offsetX, 350-offsetY);
//context.fillText(playerlasersTotal, 50, 80);


//context.fillStyle = "purple";
//context.fillRect(enemyXPos, enemyYPos, enemyWidth, enemyHeight);
//context.fillText(enemyArmor + ' ' + gravitycount + ' ' + enemyYSpeed, //enemyXPos, enemyYPos - 25);
//context.fillStyle = "#FFCCFF";
//for (var i = 0; i < enemylasers.length; i++)
//{
//context.fillRect(enemylasers[i][0], enemylasers[i][1], enemylasers[i][2], //enemylasers[i][3]);
//}


context.save();
context.translate(canvas.width/2 + 100, canvas.height/2 + 150);
context.scale(0.5,1);
context.rotate(-arcrotation*0.5*Math.PI/180);
context.strokeStyle = "orange";
context.beginPath();
context.arc(0, 0, 35, 0, 3*Math.PI/2);
context.lineWidth = 10;
context.stroke();
context.restore();

context.save();
context.translate(playerXPos+12, playerYPos + 28);
context.scale(1,0.2);
context.rotate(arcrotation*Math.PI/180);
context.strokeStyle="cyan";
context.beginPath();
context.arc(0,0,30,0,3*Math.PI/2);
context.lineWidth= 5;
context.stroke();
context.restore();

context.save();
context.translate(playerXPos+12, playerYPos + 28);
context.scale(1,0.2);
context.rotate(arcrotation*-1*Math.PI/180);
context.strokeStyle="white";
context.beginPath();
context.arc(0,0,20,0,3*Math.PI/2);
context.lineWidth= 5;
context.stroke();
context.restore();


//context.save();
//context.globalAlpha = 0.5;

for (i = 0; i < enemies.length; i++)
{
//context.fillStyle = "purple";

if( enemies[i][0] < playerXPos + 250 
&& enemies[i][0] > playerXPos -250 )

{
context.fillStyle = "lime";
context.fillText( enemies[i][11], enemies[i][0], enemies[i][1] - 30);

if ( enemies[i][10] === "right" )
{
context.drawImage( enemyImage, enemies[i][0], enemies[i][1], enemyWidth, enemyHeight);
}
else if ( enemies[i][10] === "left" )
{
context.drawImage( enemyImage2, enemies[i][0], enemies[i][1], enemyWidth, enemyHeight);
}


if (enemies[i][12] == 1)
{
context.fillStyle="red";
context.fillRect(enemies[i][0], enemies[i][1] - 25, 5, 20);
}

context.fillStyle="skyblue";
//context.fillText( i, enemies[i][0], enemies[i][1] - 10);

if (enemies[i][11] === "Alien Warrior")
{
context.fillStyle = "yellow";
}
else
{
context.fillStyle = "#33CCFF";
}

context.fillRect ( enemies[i][0] + 5, enemies[i][1] -10, enemies[i][3], 5);

}



for (j = 0; j < enemies[i][6].length; j++)
{

if( enemies[i][6][j][0] < playerXPos + 250 
&& enemies[i][6][j][0] > playerXPos -250 )
{

context.fillStyle = "#FFCCFF";
context.fillRect(enemies[i][6][j][0], enemies[i][6][j][1], laserWidth, laserHeight);

}
}

}

//context.restore();

for ( var i = 0; i < allies.length; i++ )
{
if ( allies[i][0] > playerXPos -250
&& allies[i][0] < playerXPos + 250)
{

if ( allies[i][10] === "right" )
{
context.drawImage( playerwalkcycle, Math.floor(allies[i][13])*30, 0 , 30, 30, allies[i][0], allies[i][1], 30,playerSize+6);
}
else if ( allies[i][10] === "left" )
{
context.drawImage( playerwalkcycle2, Math.floor(allies[i][13])*30, 0 , 30, 30, allies[i][0], allies[i][1], 30,playerSize+6);
}

context.fillStyle="#00FF00";
context.fillRect( allies[i][0] + 5, allies[i][1] -10, allies[i][11], 5);
}



for (var j = 0; j < allies[i][6].length; j++)
{

if ( allies[i][6][j][0] > playerXPos -250
&& allies[i][6][j][0] < playerXPos + 250)
{
context.fillStyle = "#3333FF";
context.fillRect(allies[i][6][j][0], allies[i][6][j][1], laserWidth, laserHeight);

}
}



}



for ( var i = 0; i < aliens.length; i++ )
{

if (aliens[i][0] < playerXPos + 250
&& aliens[i][0] > playerXPos -250 )
{

if ( aliens[i][10] === "right" )
{
context.drawImage( alienwalkcycle, Math.floor(aliens[i][13])*30, 0 , 30, 30, aliens[i][0], aliens[i][1], 30,playerSize+6);
}
else if ( aliens[i][10] === "left" )
{
context.drawImage( alienwalkcycle2, Math.floor(aliens[i][13])*30, 0 , 30, 30, aliens[i][0], aliens[i][1], 30,playerSize+6);
}

context.fillStyle="#00FF00";
context.fillRect( aliens[i][0] + 5, aliens[i][1] -10, aliens[i][11], 5);
}

for (var j = 0; j < aliens[i][6].length; j++)
{
if (aliens[i][6][j][0] < playerXPos + 250
&& aliens[i][6][j][0] > playerXPos -250 )
{

context.fillStyle = "#00FF00";
context.fillRect(aliens[i][6][j][0], aliens[i][6][j][1], laserWidth, laserHeight);
}

}


}



if ( playerstealth == "uncloaked" )
{
if ( playerdirection === "right" )
{
context.drawImage( playerwalkcycle, Math.floor(playerwalk)*30, 0 , 30, 30, playerXPos- offsetX,playerYPos -offsetY,30,playerSize+6);
}
else if ( playerdirection === "left" )
{
context.drawImage( playerwalkcycle2, Math.floor(playerwalk)*30, 0 ,  30, 30, playerXPos- offsetX,playerYPos -offsetY,30,playerSize+6);
}
}
else if ( playerstealth == "cloaked")
{
context.save();
context.globalAlpha = 0.5;

if ( playerdirection === "right" )
{
context.drawImage( playerwalkcycle, Math.floor(playerwalk)*30, 0 , 30, 30, playerXPos- offsetX,playerYPos -offsetY,30,30);
}
else if ( playerdirection === "left" )
{
context.drawImage( playerwalkcycle2, Math.floor(playerwalk)*30, 0 ,  30, 30, playerXPos- offsetX,playerYPos -offsetY,30,30);
}
context.restore();


}



if (playerXPos > 1500 && playerXPos < 3000)
{

context.save();
context.globalAlpha = Math.abs(playerXPos-2000)/2000*3;
 
context.drawImage( vehiclestation1, 0, 0, 484, 330, 1800, 160, 484, 330 );
context.restore();
}

//context.fillText( rightPressed + '  ' + leftPressed + 'j: ' + jkeypressed , //playerXPos, playerYPos -30);


// display stuff

var alphalaser = 1;
var laserrandom = Math.random();
if (laserrandom >= 0.5)
{
alphalaser = 0.9;
}
else if (laserrandom < 0.5)
{
alphalaser=0.5;
}

/*
context.strokeStyle = "rgba(102, 255, 51, " + alphalaser + " )";
context.beginPath();
context.moveTo(plane3XPos + 6, plane3YPos + 1);
context.lineTo(plane3XPos + 500, (20*Math.sin(healingprogress)) + plane3YPos);
context.lineWidth = 1;
context.stroke();

context.strokeStyle = "rgba(102, 255, 51, " + alphalaser + " )";
context.beginPath();
context.moveTo(plane3XPos + 6, plane3YPos + 1);
context.lineTo(plane3XPos + 500, (-20*Math.sin(healingprogress)) + plane3YPos);
context.lineWidth = 1;
context.stroke();
*/



for (var i= 0; i < hitarray4.length; i++)
{
hitarray4[i][2] -= 1;
context.fillStyle= "white";
context.fillRect( hitarray4[i][0], hitarray4[i][1], 10, 10);
if (hitarray4[i][2] <= 0)
{
hitarray4.splice(i, 1);
}
 
}

for (var i = 0; i < clouds.length; i++)
{
clouds[i][2] += 1;
clouds[i][3] -= 0.05;
context.fillStyle = "rgba(255, 255, 255, " + clouds[i][3] + ")";
context.fillRect( clouds[i][0]-clouds[i][2]/2, clouds[i][1]-clouds[i][2]/2, clouds[i][2], clouds[i][2] );
if ( clouds[i][3] <= 0.1)
{
clouds[i][3] = 0;
clouds.splice(i, 1);
}
}


for (var i = 0; i < hitarray.length; i++)
{
hitarray[i][2] += 1;
hitarray[i][3] -= 0.05;
context.fillStyle = "rgba(51, 204, 255, " + hitarray[i][3] + ")";
context.fillRect( hitarray[i][0]-hitarray[i][2]/2, hitarray[i][1]-hitarray[i][2]/2, hitarray[i][2], hitarray[i][2] );
if ( hitarray[i][3] <= 0.1)
{
hitarray[i][3] = 0;
hitarray.splice(i, 1);
}
}

for (var i = 0; i < hitarray2.length; i++)
{
hitarray2[i][2] += 1;
hitarray2[i][3] -= 0.05;
context.fillStyle = "rgba(248, 207, 252, " + hitarray2[i][3] + ")";
context.fillRect( hitarray2[i][0]-hitarray2[i][2]/2, hitarray2[i][1]-hitarray2[i][2]/2, hitarray2[i][2], hitarray2[i][2] );
if ( hitarray2[i][3] <= 0.1)
{
hitarray2[i][3] = 0;
hitarray2.splice(i, 1);
}
}
for (var i = 0; i < hitarray3.length; i++)
{
hitarray3[i][2] += 16;
hitarray3[i][3] -= 0.4;
//context.fillStyle = "rgba(255, 180, 5, " + hitarray3[i][3] + ")";
context.fillStyle = "rgba(0, 255, 255, " + hitarray3[i][3] + ")";
context.fillRect( hitarray3[i][0]-hitarray3[i][2]/2, hitarray3[i][1]-hitarray3[i][2]/2, hitarray3[i][2], hitarray3[i][2] );
if ( hitarray3[i][3] <= 0.1)
{
hitarray3[i][3] = 0;
hitarray3.splice(i, 1);
}
}
for ( var i = 0; i < energycubes.length; i++)
{
if ( playerXPos <= energycubes[i][0] + 15
&& energycubes[i][0] <= playerXPos + 24
&& playerYPos <= energycubes[i][1] + 70 + 15
&& energycubes[i][1] + 70 < playerYPos + 24 && playerShields < 50)
{
energycubes.splice( i, 1);
playenergycubesound();
playerShieldsstatus = "recharging";
}
}

if (playerShieldsstatus === "recharging" && playerShields < 50)
{
playerShields += 1;
}
if (playerShields >= 50)
{
playerShieldsstatus = "notcharging";
}

//context.save();
//context.globalCompositeOperation = "lighter";
for (h=0; h<playerlasers.length; h++)
{


laserX = playerlasers[h][0];
laserY = playerlasers[h][1]-10;

for ( var i = 0; i < 19; i++ )
{
for ( var j = 0; j < 38; j++ )
{
if ( lasers[i][j] == 1 )
{
context.fillStyle = 'rgba(255, 255, 30, '+ 0.1 +')';
//context.fillRect(j*laserSize+laserX, i*laserSize+laserY, laserSize, laserSize);
}
if ( lasers[i][j] == 2 )
{
context.fillStyle = 'rgba(255, 255, 30, '+ 0.2 +')';
//context.fillRect(j*laserSize+laserX, i*laserSize+laserY, laserSize, laserSize);
}
if ( lasers[i][j] == 3 )
{
context.fillStyle = 'rgba(255, 255, 30, '+ 0.3 +')';
//context.fillRect(j*laserSize+laserX, i*laserSize+laserY, laserSize, laserSize);
}
if ( lasers[i][j] == 4 )
{
context.fillStyle = 'rgba(255, 255, 30, '+ 0.4 +')';
//context.fillRect(j*laserSize+laserX, i*laserSize+laserY, laserSize, laserSize);
}
if ( lasers[i][j] == 5 )
{
context.fillStyle = 'rgba(255, 255, 30, '+ 0.8 +')';
//context.fillRect(j*laserSize+laserX, i*laserSize+laserY, laserSize, laserSize);
}
if ( lasers[i][j] == 6 )
{
context.fillStyle = 'rgba(255, 255, 30, '+ 0.9 +')';
//context.fillRect(j*laserSize+laserX, i*laserSize+laserY, laserSize, laserSize);
}
if ( lasers[i][j] == 7)
{
context.fillStyle = "#FFFFFF";
//context.fillRect( j*laserSize+laserX, i*laserSize+laserY, laserSize, laserSize);
}
}
}

}
//context.restore();

//context.drawImage(flareImage, playerXPos, playerYPos, 100, 100);
//context.globalCompositeOperation = "lighter";
//context.globalCompositeOperation = "hard-light";
//context.globalCompositeOperation = "multiply";
//for ( var i= 0; i < playerlasers.length; i++)
//{
//context.drawImage( lightImage, playerlasers[i][0]-50, playerlasers[i][1]-10, //100, 20);
//}
//context2.globalCompositeOperation = "multiply";
//context2.drawImage( lightImage, playerXPos, playerYPos);
//context2.drawImage( lightImage, playerXPos, playerYPos-80);
//context2.save();
//context2.globalCompositeOperation = "destination-out";
//context2.restore();
//context2.drawImage( lightImage, playerXPos, playerYPos);
//context2.drawImage( lightImage, playerXPos, playerYPos-80);
var points = [ {x:playerXPos,y:playerYPos}, {x:controlpoints[0][0],y:controlpoints[0][1]}, {x:controlpoints[1][0],y:controlpoints[1][1]}];
if ( playerlasers[4] )
{
var points = [ {x:playerXPos,y:playerYPos}, {x:controlpoints[0][0],y:controlpoints[0][1]}, {x:controlpoints[1][0],y:controlpoints[1][1]}, {x:playerlasers[0][0] ,y:playerlasers[0][1] }, {x:playerlasers[1][0] ,y:playerlasers[1][1] }, {x:playerlasers[2][0] ,y:playerlasers[2][1] }, {x:playerlasers[3][0] ,y:playerlasers[3][1] }, {x:playerlasers[4][0] ,y:playerlasers[4][1] }];
}

var renderMarker = function(point) {
context2.save();
context2.translate(point.x, point.y);
context2.rotate(Math.PI/4);
context2.fillRect(-5,-5,10,10);
context2.restore();
};
var renderScannerFill = function(point, radius) {
context2.save();
var grd=context2.createRadialGradient(point.x+10,point.y+10,5,point.x+10,point.y+10, 80);
context2.translate(point.x, point.y);
context2.beginPath();
context2.arc(0,0,radius,0,2*Math.PI);
context2.lineWidth = 3;
context2.fill();
//context2.restore();
//context2.save();
//grd.addColorStop(0,"transparent");
//grd.addColorStop(1, "red");
//context2.fillStyle = grd;
//context2.beginPath();
// context2.arc(0, 0, radius,0,2*Math.PI);
//context2.lineWidth = 3;
//context2.fill();
context2.restore();
};
//context2.fillStyle="black";
//context2.fillRect(0, 0, 1000, 1000);
//context2.fillStyle =
//context2.strokeStyle = "rgba(120,256,120,1.0)";
context2.strokeStyle = "#33CCFF";
context2.fillStyle="#33CCFF";
var i;
for(i=0; i<points.length; i++) {
var grd=context2.createRadialGradient(points[i].x+10,points[i].y+10,1,points[i].x+10,points[i].y+10, 100);
//context2.fillStyle = grd;
//grd.addColorStop(0,"transparent");
//grd.addColorStop(1, "black");
//context2.beginPath();
//context2.arc(points[i].x, points[i].y, 100,0,2*Math.PI);
//context2.lineWidth = 3;
//context2.fill();
//renderScannerFill(points[i], 75);
//renderMarker(points[i]);
}
context2.save();
//context2.globalCompositeOperation = "destination-out";
for(i=0; i<points.length; i++) {
var grd=context2.createRadialGradient(points[i].x+10,points[i].y+10,1,points[i].x+10,points[i].y+10, 100);
//context2.fillStyle = grd;
//grd.addColorStop(1,"transparent");
//grd.addColorStop(0, "black");
//context2.beginPath();
//context2.arc(points[i].x, points[i].y, 100,0,2*Math.PI);
//context2.lineWidth = 3;
//context2.fill();
//renderScannerFill(points[i], 70);
}
context2.restore();
//var //grd=context2.createRadialGradient(playerXPos+10,playerYPos+10,1,playerXPo///s+10,playerYPos+10, 80);
//grd.addColorStop(0,"transparent");
//grd.addColorStop(1, "#33CCFF");
//context2.fillStyle = grd;
//context2.beginPath();
// context2.arc(playerXPos,playerYPos,80,0,2*Math.PI);
// context2.lineWidth = 3;
//context2.fill();
//for(i=0; i<points.length; i++) {
// renderMarker(points[i]);
//}
//if ( laserimagestatus >= 1 && laserimagestatus <= 3)
//{
//context.drawImage( laser1Image, playerXPos+ 75, playerYPos+ 15, 9, 12 );
//context.drawImage( laser3Image, playerXPos+ 75, playerYPos, 80, 45 );
//}
//else if ( laserimagestatus >= 4 && laserimagestatus <= 6)
//{
//context.drawImage( laser2Image, playerXPos+ 75, playerYPos+ 5, 20, 30 );
//context.drawImage( laser3Image, playerXPos+ 75, playerYPos+10, 80, 35 );
//}
//else if ( laserimagestatus >= 7 && laserimagestatus <= 9)
//{
//context.drawImage( laser3Image, playerXPos+ 75, playerYPos+15, 80, 15 );
//}
//else if ( laserimagestatus == 6 || laserimagestatus == 7)
//{
//context.drawImage( laser4Image, playerXPos - 60, playerYPos- 25, 200, 100 );
//}
laserimagestatus += 1;
plane2Rotation += plane2RotationSpeed;
//context.save();
//context.scale(-1, 1);

//context.drawImage( vehicleImage, vehicle2XPos-200, vehicle2YPos-50, 150, //110);

//context.restore();
var rad = plane2Rotation * Math.PI / 180;
context.save();
//Set the origin to the center of the image
context.translate(vehicle2XPos -100+ 5/2+15, vehicle2YPos + 45 );
//Rotate the canvas around the origin
context.rotate(rad);
//draw the image
context.fillStyle="blue";

//context.drawImage( tireImage, -30/2,-30/2, 30, 30);
//reset the canvas
context.restore();
context.save();
//Set the origin to the center of the image
context.translate(vehicle2XPos -100+ 5/2-30, vehicle2YPos + 45 );
//Rotate the canvas around the origin
context.rotate(rad);
//draw the image
context.fillStyle="blue";

//context.drawImage( tireImage, -30/2,-30/2, 30, 30);
//reset the canvas
context.restore();
context.save();
//Set the origin to the center of the image
context.translate(vehicle2XPos -100+ 5/2-80, vehicle2YPos + 45 );
//Rotate the canvas around the origin
context.rotate(rad);
//draw the image
context.fillStyle="blue";

//context.drawImage( tireImage, -30/2,-30/2, 30, 30);
//reset the canvas
context.restore();
lightImage2count1 += 1;
if ( lightImage2count1 >= 5)
{
lightImage2count+=1;
lightImage2count1 = 0;
}
if ( lightImage2count >= 3)
{
lightImage2count = 0;
}
if ( controlpoints.length > 0 )
{
//if ( lightImage2progress >= 100)
//{
//lightImage2progress = 1;
//}
if ( lightImage2progress >= 60)
{
level[11][25] = 0;
level[12][25] = 0;
level[11][26] = 0;
level[12][26] = 1;
level[11][27] = 0;
level[12][27] = 0;
level[10][25] = 0;
level[10][26] = 0;
}
if ( Math.floor(lightImage2progress) == 60 )
{
hitarray.push([Math.random()*100+800, Math.random()*60+350, 10, 1]);
hitarray.push([Math.random()*100+800, Math.random()*60+350, 10, 1]);
hitarray.push([Math.random()*100+800, Math.random()*60+350, 10, 1]);
hitarray.push([Math.random()*100+800, Math.random()*60+350, 10, 1]);
hitarray.push([Math.random()*100+800, Math.random()*60+350, 10, 1]);
}
if ( controlpoints[2][2] >= 100 && lightImage2progress < 65)
{
lightImage2progress += 0.1;
}
if ( controlpoints[2][2] >= 100 && lightImage2progress < 60)
{
context.drawImage( lightImage2, 0, lightImage2count*45, 146, 45, 800, 340+lightImage2progress, 146/2, 45/2);
}
}
for ( var i = 0; i < sparkarray.length; i++)
{
if ( controlpoints[2][2] )
{
context.fillStyle = sparkarray[i][6];


}
//context.fillRect(sparkarray[i][0], sparkarray[i][1], sparkarray[i][5], sparkarray[i]
//[5]);
context.strokeStyle=sparkarray[i][6];

context.fillStyle="white";
context.lineWidth= 3;
context.beginPath();
context.arc(sparkarray[i][0], sparkarray[i][1], sparkarray[i][4]/20 *5, 0, 2*Math.PI); 
context.stroke();
context.fill();
}
context.rect(0, 0, 200, 200);
//var2 += 1;
//if ( var2 >= 5)
//{
var1 += 1;
//var2 = 0;
//}
if ( var1 >= 150)
{
var1 = -150;
}
context.save();
context.globalAlpha = 0.6;
//context2.drawImage( panelImage, 0, 0, 200, 200);
context.beginPath();
context.arc(100, 100, 90, 0, 2 * Math.PI, false);
context.fillStyle = '#33CCFF';
context.fill();
context.restore();
//context.globalAlpha = 1;
context2.drawImage( panelImage, 0, 0, 200, 200);
context2.clearRect(0, 0, (200*0.3+var1+20), 200);
context2.clearRect((200*0.7+var1-20), 0, (200*0.7+var1+100)+500, 200);
var gradient1 = context.createLinearGradient(0+var1, 0, 200+var1, 0);
gradient1.addColorStop(0.39, 'rgba(255, 255, 255, '+ 0 +' )' );
gradient1.addColorStop(0.4, 'rgba(255, 255, 255, '+ 1 +' )' );
gradient1.addColorStop(0.41, 'rgba(255, 255, 255, '+ 0 +' )');
gradient1.addColorStop(0.5, 'rgba(255, 255, 255, '+ 0 +' )');
gradient1.addColorStop(0.59, 'rgba(255, 255, 255, '+ 0 +' )');
gradient1.addColorStop(0.6, 'rgba(255, 255, 255, '+ 1 +' )');
gradient1.addColorStop(0.61, 'rgba(255, 255, 255, '+ 0 +' )' );
context2.fillStyle = gradient1;
context2.fill();
context2.save();
context2.globalCompositeOperation = "destination-in";
context2.beginPath();
context2.arc(100, 100, 90, 0, 2 * Math.PI, false);
context2.fillStyle = 'green';
context2.fill();
context2.restore();
context2.arc(100, 100, 90, 0, 2 * Math.PI, false);
context2.strokeStyle="black";
context2.lineWidth= 10;
context2.stroke();
var rad1 = cannonRotation * Math.PI/180;
context.save();
context.translate( cannonX, cannonY);
context.rotate(rad1);
//context.fillStyle="green";

context.drawImage( laserblasterImage, 0, 0, 161, 92, -100/2, -55/2, 100, 55 );

//context.fillRect( -100/2, -50/2, 100, 50);

context.fillStyle="gray";
context.fillRect( 0+ cannonXPos1, -50/2+50, 50, 10);
context.restore();
for ( var i = 0; i < cannonarray.length; i++ )
{
context.save();
context.translate( cannonarray[i][0], cannonarray[i][1]);
cannonarray[i][5] = cannonarray[i][4] * Math.PI/180;
context.rotate(cannonarray[i][5]);
context.fillStyle="cyan";
context.fillRect( 0, -2/2, 25, 2);
context.restore();
}
var rad2 = planeRotation * Math.PI/180;
context.save();
context.translate( plane3XPos, plane3YPos);
context.rotate(rad2);
context.fillStyle="Lime";
context.fillRect( -10/2, -5/2, 10, 5);
context.drawImage( blasterimage, Math.floor(blastercount)*100, 0 , 100, 44, -100/2, -44/2 - 5, 100, 44);
context.restore();

for ( f=0; f < flarearray.length; f++)
{
if (flarearray[f][0] == 1)
{
context.drawImage( laser3Image, 0, 0, 74, 90, plane3XPos+ 41, plane3YPos-22, 25, 20);
}
if (flarearray[f][0] == 2)
{
context.drawImage( laser3Image, 0, 0, 74, 90, plane3XPos+ 41, plane3YPos, 25, 20);
}
if (flarearray[f][0] == 0)
{
context.drawImage( laser3Image, 0, 0, 74, 90, plane3XPos+ 49, plane3YPos-11, 25, 20);

}

flarearray[f][1] -= 1;
if (flarearray[f][1] <= 0)
{
flarearray.splice(f, 1);
}

}





mechXPos += mechXSpeed;
mechXPos1+= 1;
if ( mechXPos1 >= 5)
{
mechXPos1 = 0;
mechXPos2+=1;
}
if ( mechXPos2 >= 8)
{
mechXPos2 = 0;
}
if ( mechXPos >= 3000 && mechXSpeed > 0)
{
mechXSpeed = -2;
mechDirection = "left";
//mechXPos2 = 1;
}
else if ( mechXPos <= 1600 && mechXSpeed < 0)
{
mechXSpeed = 2;
mechDirection = "right";
}
//context.fillStyle="green";
//context.fillRect( mechXPos, mechYPos, 100, 108);



if ( mechDirection === "right")
{
context.save();
//context.translate(-mechXPos, 0);

context.scale(-1, 1);
context.drawImage(mechImage, mechXPos2*100, 0, 100, 108, -mechXPos-100, mechYPos, 100, 108);
context.restore();

}
else if ( mechDirection === "left" )
{
context.drawImage( mechImage, mechXPos2*100, 0, 100, 108, mechXPos, mechYPos, 100, 108);
}


context.fillStyle="blue";
if ( mechDirection === "right" )
{

if ( astroguard2L == 0)
{

if ( mechXPos2 ==2 || mechXPos2 == 3 || mechXPos2 == 6 || mechXPos2 == 7)
{
context.fillRect( mechXPos+60-5, mechYPos+30, 50, 10);
}
else
{
context.fillRect( mechXPos+60-5, mechYPos+35, 50, 10);
}


}
else
{
if ( mechXPos2 ==2 || mechXPos2 == 3 || mechXPos2 == 6 || mechXPos2 == 7)
{
context.fillRect( mechXPos+60, mechYPos+30, 50, 10);
}
else
{
context.fillRect( mechXPos+60, mechYPos+35, 50, 10);
}

}


}
else if ( mechDirection === "left")
{

if (astroguard2L == 0)
{

if ( mechXPos2 ==2 || mechXPos2 == 3 || mechXPos2 == 6 || mechXPos2 == 7)
{
context.fillRect( mechXPos-15+5, mechYPos+30, 50, 10);
}
else
{
context.fillRect( mechXPos-15+5, mechYPos+35, 50, 10);
}

}
else
{

if ( mechXPos2 ==2 || mechXPos2 == 3 || mechXPos2 == 6 || mechXPos2 == 7)
{
context.fillRect( mechXPos-15, mechYPos+30, 50, 10);
}
else
{
context.fillRect( mechXPos-15, mechYPos+35, 50, 10);
}

}

}


for ( var i = 0; i < glowArray.length; i++)
{
if (glowArray[i][0] < playerXPos + 250
&& glowArray[i][0] > playerXPos -250)
{

context.drawImage( glowImage, glowArray[i][0], glowArray[i][1]);
}

}

context.fillStyle="#0099FF";

//context.font = "12px Lucida Sans Unicode";
//context.fillText( "Objective: restore power to the base" + ' ' + playerYSpeed, //playerXPos -12, playerYPos -50);

//objective stuff





//context.fillStyle= 'rgba(0, 255, 255, 0.5 )';
//context.fillRect(970-70, 50, 100+24, 50+24);



//add draw stuff

if (upPressed)
{
jetpackingL += 0.3;
}
else
{
jetpackingL = 0;
}

if (Math.floor(jetpackingL) >= 3)
{
jetpackingL = 1.5;
}

if ( playerdirection === "right")
{
context.save();
context.scale(-1, 1);
context.drawImage( jetpacking, 50* Math.floor(jetpackingL), 0, 50, 50, -(playerXPos+15), playerYPos+10, 30, 30);
context.restore();
}
else
{
context.drawImage( jetpacking, 50* Math.floor(jetpackingL), 0, 50, 50, playerXPos+15, playerYPos+10, 30, 30);
}

if (mkeypressed)
{
alienguardL += 0.3;
}
else 
{
alienguardL = 0;
}

if (Math.floor(alienguardL) >= 3)
{
alienguardL = 0;
}

context.drawImage(alienguard, 50*Math.floor(alienguardL), 0, 50, 50, alienguardX, alienguardY, 50, 50); 



context.strokeStyle = "#808080";
context.lineWidth = 3;
context.beginPath();
context.moveTo( gX + 5, gY + 5);
context.lineTo(playerXPos + 12, playerYPos+ 12);
context.stroke();

context.fillStyle = "gray";
context.fillRect( gX, gY, 10, 10);



var c3 = context;

if (br5 == 0)
{
br4 += 1;
}

if (br4 >= 100)
{
br5 = 1;
br4 = 0;
}


if (br <= -90 && br2 < 0)
{
br = -45;
br2 = br3;
}
if ( br >= 10 && br2 > 0 )
{
br = 0;
br2 = br3*2.5*-1;
br5 = 0;
}

if (br5 == 1)
{
br += br2;
}

var laserlocation = Math.cos(br*Math.PI/180)* 20 + 100;

/*
c3.fillStyle = "#CC33FF";
c3.save();
c3.translate(laserlocation, laserlocation);
c3.rotate( br*Math.PI/180);
c3.fillRect(0, -10/2, 30, 10);
c3.fillStyle="#996600";
c3.fillRect(-15, -10/2+10, 20, 10);
c3.restore();


c3.beginPath();
c3.lineWidth= 10;
c3.strokeStyle="#996600";
c3.moveTo( ((80+20 + laserlocation)/2)+1, 100+14);
c3.lineTo( 80+ 20, 90+10);
c3.stroke();

//c3.fillStyle="blue";
//c3.fillRect(100, 100, 20, 20);

c3.fillRect(0, 0, 10, 50);
*/

if (astroguard2L == 0 && mkeypressed)
{
//guardlasers.push([230, 295+15, 10]);
guardlasercount = 0;
}

//astroguardL += 0.2;


astroguard2L += 0.3;


//if (Math.floor(astroguardL) >= 8)
//{
//astroguardL = 0;
//}

if (Math.floor(astroguard2L) >= 9)
{
astroguard2L = 0;

//guardlasercount = 1;
}

//context.drawImage(astroguard, 100*Math.floor( astroguardL ), 0, 100, 100, 200, //250, 100, 100);

//context.drawImage(astroguard2, 100*Math.floor( astroguard2L //), 0, 100, 100, 200, 290, 50, 50);

for ( var i = 0; i< guards.length; i++)
{
context.drawImage(astroguard2, 100*Math.floor( astroguard2L ), 0, 100, 100, guards[i][0]-20, guards[i][1]-20, 50, 50);
context.fillStyle="white";
//context.fillText(i, guards[i][0],guards[i][1]);
//tag1
}

for (var i= 0; i< laserexplosions.length; i++)
{
context.drawImage( laserexplosion, 20*Math.floor(laserexplosions[i][2]), 0, 20, 20, laserexplosions[i][0], laserexplosions[i][1], 20, 20);
}


context.fillStyle="rgba(51, 204, 255, " + glassalpha+ " ) ";

context.fillRect( 520, 64, 10, 95);

context.fillStyle="rgba(51, 204, 255, 0.5)";

for ( var i= 0; i< glassarray.length; i++)
{
context.save();
context.translate(glassarray[i][0], glassarray[i][1]);
context.rotate(glassarray[i][2]*Math.PI/180);
context.fillRect( -10/2, -10/2, 10, 10);
context.restore();
}


var ctx2 = context;



for ( var i = 0; i < warriors.length; i++)
{



if ( warriors[i][2] === "vaultingoverbox")
{

warriors[i][9] += 1;

if ( warriors[i][9] >= 5 )
{
warriors[i][8] += 1;
warriors[i][9] = 0;
}

if (  warriors[i][8] == 5 && warriors[i][10] == 0 )
{
warriors[i][8] = 0;
warriors[i][10] = 1;
}
if (  warriors[i][8] == 3 && warriors[i][10] == 1 )
{
warriors[i][8] == 2;
warriors[i][10] == 1;
warriors[i][2] = "scouting";
}

ctx2.drawImage(alienjumping, warriors[i][8]*101,100*warriors[i][10],100,100,warriors[i][0],warriors[i][1],100,100 );

}
else if ( warriors[i][2] === "letsgo" )
{
warriors[i][11] += 1;

if ( warriors[i][11] >= 10)
{
warriors[i][12] += 1;
warriors[i][11] = 0;
}


if ( warriors[i][12] == 5)
{
warriors[i][2] = "scanning";
}


ctx2.drawImage(alienjumping, warriors[i][12]*101,100,100,100,warriors[i][0], warriors[i][1] ,100,100 );
}



if (playerXPos > warriors[i][0] - 100 && warriors[i][12] !== 5 && warriors[i][8] !== 3)
{
warriors[i][2] = "vaultingoverbox";
}


}





//here's the format: image, start clipping x, start clipping y, display x, display //size y, position x, position y, default x, default y

// warriors and stuff


for ( i = 0; i < warriors.length; i++)
{

var warriorX = warriors[i][0],
warriorY = warriors[i][1],
//warriorL = warriors[i][3],
//warriorR = warriors[i][4],
wlo = warriors[i][5],
wloy = warriors[i][6];

var ctx = context;

//ctx.fillText(warriors[i][3], warriors[i][0], warriors[i][1]);

if ( warriors[i][2] === "landing")
{
//landing from pod
ctx.drawImage(alienstuff, 0, 0, 36, 30, warriorX, warriorY, 36, 30);
}
else if ( warriors[i][2] === "scouting")
{
//scouting the area
ctx.drawImage(alienstuff, 38, 0, 24, 30, warriorX, warriorY, 24, 30);
}
else if ( warriors[i][2] === "hit")
{
//hit with laser
ctx.drawImage(alienstuff, 61, 0, 27, 30, warriorX, warriorY, 27, 30);
}
else if ( warriors[i][2] === "scanning")
{

//scanning with laser
if ( warriors[i][4] === 0)
{
ctx.drawImage(alienstuff, 87, 0, 34, 37, warriorX, warriorY, 34, 37);
}
else if ( warriors[i][4] === 1)
{
ctx.drawImage(alienstuff2, 87, 0, 38, 37, warriorX, warriorY, 38, 37);
}

}
else if ( warriors[i][2] === "jetpack")
{
//jetpack alien
ctx.drawImage(alienstuff, 87, 34, 34, 40, warriorX, warriorY, 34, 40);
}
else if ( warriors[i][2] === "lesstactical")
{
//less tactical
if ( warriors[i][4] === 0)
{
ctx.drawImage(alienstuff, 37, 34, 35, 40, warriorX, warriorY, 35, 40);
}
else if( warriors[i][4] === 1)
{
ctx.drawImage(alienstuff2, 37, 34, 35, 40, warriorX, warriorY, 35, 40);
}

}
else if ( warriors[i][2] === "kneel")
{
//kneeled down
if ( warriors[i][4] === 0)
{
ctx.drawImage(alienstuff, 0, 30, 36, 35, warriorX, warriorY, 36, 35);
}
else if ( warriors[i][4] === 1)
{
ctx.drawImage(alienstuff2, 0, 30, 36, 35, warriorX, warriorY, 36, 35);
}

}



if (warriors[i][2] === "scanning")
{
wlo = 21;
wloy = 4;
}
else if (warriors[i][2] === "lesstactical")
{
wlo = 26;
wloy = 9;
}
else if (warriors[i][2] === "kneel")
{
wlo = 23;
wloy = 11;
}

warriors[i][3] += 1;

if (warriors[i][2] !== "hit" && warriors[i][2] !== "scouting" && warriors[i][2] !== "landing" && warriors[i][2] !== "jetpack" )
{

if ( warriors[i][3]  >= 0 && warriors[i][3] < 5)
{
//laser one
ctx.drawImage(alienstuff, 0, 63, 25, 18, warriorX-43+ wlo, warriorY+ wloy, 25, 10);
warriors[i][4] = 0;
}
else if ( warriors[i][3] >= 5 && warriors[i][3] < 10)
{
//laser two
ctx.drawImage(alienstuff, 25, 63, 20, 18, warriorX- 30+ wlo, warriorY + wloy, 25, 10);
warriors[i][4] = 1;
}
else if ( warriors[i][3] >= 10 && warriors[i][3] < 15)
{
//laser one
ctx.drawImage(alienstuff, 0, 63, 25, 18, warriorX-43 + wlo, warriorY + wloy, 25, 10);
warriors[i][4] = 0;
}
else if ( warriors[i][3] >= 15 && warriors[i][3] <= 20)
{
//laser two
ctx.drawImage(alienstuff, 25, 63, 20, 18, warriorX- 30+ wlo, warriorY+ wloy, 25, 10);
warriors[i][4] = 1;
}

}

if (warriors[i][3] >= 20)
{
warriors[i][3] = -15;
}

if (warriors[i][4] === 0 )
{

if ( warriors[i][2] === "scanning" )
{
warriorlasers.push([warriorX- 300 , warriorY+8]);
}
else if ( warriors[i][2] === "lesstactical")
{
warriorlasers.push([warriorX- 300 + 7 , warriorY+8+5]);
}
else if ( warriors[i][2] === "kneel")
{
warriorlasers.push([warriorX- 300 + 2 , warriorY+8+7]);
}

}






}


context.strokeStyle = "#CCFFFF";
for (var i =0; i<warriorlasers.length; i++)
{
context.lineWidth = 1;
context.beginPath();
context.moveTo(544, warriorlasers[i][1]);
context.lineTo(warriorlasers[i][0]+300, warriorlasers[i][1]);
context.stroke();
}

for ( var i = 0; i< guardlasers.length; i++)
{
context.drawImage( astroguard2laser, guardlasers[i][0], guardlasers[i][1], 96/2, 20/2);
}

if (warriors[0])
{
//context.strokeStyle = "lime";
//context.lineWidth = 1;
//context.beginPath();
//context.moveTo(532, 0);
//context.lineTo(playerXPos, playerYPos);
//context.stroke();

//context.beginPath();
//context.moveTo(warriors[0][0], warriors[0][1]);

var resultstuff = checkLineIntersection(warriors[0][0], warriors[0][1], warriors[0][0] - 500, warriors[0][1], 532, 0, playerXPos, playerYPos);
//context.lineTo(resultstuff.x, resultstuff.y);
//context.stroke();

//context.beginPath();
//context.fillStyle="lime";
//context.arc( resultstuff.x, resultstuff.y, 5, 0, 2*Math.PI);
//context.stroke();
//context.fill();
}

function checkLineIntersection(line1StartX, line1StartY, line1EndX, line1EndY, line2StartX, line2StartY, line2EndX, line2EndY) {

    var denominator, a, b, numerator1, numerator2, result = {
        x: null,
        y: null,
        onLine1: false,
        onLine2: false
    };
    denominator = ((line2EndY - line2StartY) * (line1EndX - line1StartX)) - ((line2EndX - line2StartX) * (line1EndY - line1StartY));
    if (denominator == 0) {
        return result;
    }
    a = line1StartY - line2StartY;
    b = line1StartX - line2StartX;
    numerator1 = ((line2EndX - line2StartX) * a) - ((line2EndY - line2StartY) * b);
    numerator2 = ((line1EndX - line1StartX) * a) - ((line1EndY - line1StartY) * b);
    a = numerator1 / denominator;
    b = numerator2 / denominator;

    // if we cast these lines infinitely in both directions, they intersect here:
    result.x = line1StartX + (a * (line1EndX - line1StartX));
    result.y = line1StartY + (a * (line1EndY - line1StartY));

    // if line1 is a segment and line2 is infinite, they intersect if:
    if (a > 0 && a < 1) {
        result.onLine1 = true;
    }
    // if line2 is a segment and line1 is infinite, they intersect if:
    if (b > 0 && b < 1) {
        result.onLine2 = true;
    }
    // if line1 and line2 are segments, they intersect if both of the above are true
    return result;
};

// line intersection: http://jsfiddle.net/justin_c_rounds/Gd2S2/

for (i=0; i<warriorlasers.length;i++)
{
warriorlasers[i][0]+=-300;

if (warriorlasers[i][0] <= 0)
{
warriorlasers.splice(i,1);
}
}

for (var i = 0; i< guardlasers.length; i++)
{
guardlasers[i][0] += guardlasers[i][2];

if (guardlasers[i][0] >= 4500 || guardlasers[i][0] <= 0 )
{
guardlasers.splice(i, 1);
}
}

var scale = 5;
var turretoffsetX = 23;
var turretoffsetY = -8;
if (pulselaserC <= 0.1 )
{
pulselaserC = 1.1;
}

pulselaserC -= 0.01;
 
if (enemies[2])
{
context.fillStyle = "rgba(5, 247, 37, " + pulselaserC + "  )";
context.fillRect(enemies[2][0], enemies[2][1] + 10, 50, 5);
}







context.save();
context.translate(turretX, turretY);
context.rotate(turretR*Math.PI/180);
context.fillStyle="gray";
context.fillRect(-50/2, -10/2, 50, 10);
context.restore();

turretfirerate += 1;

if (turretfirerate >= 15 && turretfiring == 0)
{
turretfiring = 1;
turretfirerate = 0;
}




if (turretfiring == 1)
{

turretR -= 5;
if (turretR <= -25)
{
turretR = 0;
turretfiring = 0;
}



turretstatus += 2;
if (turretstatus < 5 && turretstatus > 0)
{
context.fillStyle= "cyan";
context.fillRect(turretX+turretoffsetX, turretY+turretoffsetY, 50/scale, 50/scale);
context.fillStyle= "white";
context.fillRect(turretX+turretoffsetX+5/scale, turretY+turretoffsetY+5/scale, (50-10)/scale, (50-10)/scale);

}
else if (turretstatus < 10 && turretstatus > 0)
{
context.fillStyle="cyan";
context.fillRect(turretX+turretoffsetX, turretY+turretoffsetY+10/scale, 40/scale, 30/scale);
context.fillStyle="white";
context.fillRect(turretX+turretoffsetX+5/scale, turretY+turretoffsetY+(10+5)/scale, (40-10)/scale, (30-10)/scale);
}

if (turretstatus >= 15 && turretR == 0)
{
turretstatus = -5;
}

}

for (i=0; i< beaconarray.length; i++)
{
context.fillStyle="red";
context.fillRect(beaconarray[i][0], beaconarray[i][1], 200, 10);
}

if (medichere === "active" && playerArmor < 100 )
{
playerArmor += 3;
context.strokeStyle = "lime";
context.beginPath();
context.moveTo( allies[1][0] + 12, allies[1][1] + 12);
context.lineTo(playerXPos + 12, playerYPos + 12);
context.lineWidth = 2;
context.stroke();
}

//context.drawImage( shieldimage, 200, plane3YPos - 80);

arcrotation += 1;
context.fillStyle="orange";


for ( var a=0; a < 5; a++)
{
context.fillRect(365+a*35, 435, 25, 10);
}


context.fillRect(365, 445, 175, 5);

//context.save();

//context.translate(canvas.width/2 + 100, canvas.height/2 +150);
//context.scale(0.5,1);
//context.rotate(arcrotation*Math.PI/180);
//context.strokeStyle = "#33CCFF";
//context.beginPath();
//context.arc(0, 0, 50, 0, Math.PI);
//context.lineWidth = 3;
//context.stroke();

//context.restore();




/*
if (mkeypressed)
{
s1 += 1;
}
if (jkeypressed)
{
s1 -= 1;
}
if (skeypressed)
{
s2+=1;
}
if (ukeypressed)
{
s2 -= 1;
}
*/

context3.translate( offsetX, offsetY);
context3.clearRect(0,0, 500, 500);

//context3.fillStyle="black";
//context3.fillRect(200, 250, 100, 100);
//context3.drawImage(canvas, s1, s2, 100, 100, 200, 250, 100, 100);

//context3.fillStyle="lime";
//context3.save();
//context3.globalAlpha = 0.5;
//context3.fillRect(200, 250, 100, 100);
//context3.restore();

context3.save();


context3.translate(canvas.width/2 + 100, canvas.height/2 +150);
context3.scale(0.5,1);
context3.rotate(-arcrotation*0.5*Math.PI/180);
context3.strokeStyle = "orange";
context3.beginPath();
context3.arc(0, 0, 35, 0, 3*Math.PI/2);
context3.lineWidth = 10;
context3.stroke();

context3.restore();
context3.clearRect(320, 395, 30, 110);


/*
for (h=0; h < 1; h++)
{

context3.save();
//context3.clip();
context3.translate(canvas.width/2 + 110+(h*10), canvas.height/2 +150);
context3.scale(0.5,1);
context3.rotate(-arcrotation*0.5*Math.PI/180);
context3.strokeStyle = "orange";
context3.beginPath();
context3.arc(0, 0, 35, 0, 3*Math.PI/2);
context3.lineWidth = 3;
context3.stroke();

context3.restore();
}
*/

greenbox -= 0.01;
greenbox2 +=0.01;

if (greenbox < 0.2)
{
greenbox = 1;
greenbox2 = 0.1;
}





context.save();
context.globalAlpha = 0.5;
context.fillStyle="rgba(0, 255, 0, "+ greenbox + " )";
context.fillRect(33*tileSize-10*(greenbox2), 6*tileSize-10*(greenbox2), tileSize+20*(greenbox2), tileSize+20*(greenbox2));
context.restore();


context.save();
context.globalAlpha = 0.5;
context.fillStyle="#00FF00";
context.fillRect(33*tileSize, 6*tileSize, tileSize, tileSize);
context.restore();


for ( h=0; h < healingparticles.length; h++)
{
      context.beginPath();
      context.arc( healingparticles[h][0], healingparticles[h][1], 2, 0, 2 * Math.PI, false);
      context.fillStyle = '#33CCFF';
      context.fill();

}

for ( h=0; h < healingparticles2.length; h++)
{
      context.beginPath();
      context.arc( healingparticles2[h][0], healingparticles2[h][1], 2, 0, 2 * Math.PI, false);
      context.fillStyle = '#FFA500';
      context.fill();
}

for (h=0; h <shipparts.length; h++)
{
context.fillStyle= shipparts[h][4];
context.fillRect( shipparts[h][0] + alienshipXPos, shipparts[h][1] + alienshipYPos, shipparts[h][2], shipparts[h][3] ); 

}

for (h=0; h <ship2parts.length; h++)
{
context.fillStyle= ship2parts[h][4];
context.fillRect( ship2parts[h][0] + astroship2XPos, ship2parts[h][1] + astroship2YPos, ship2parts[h][2], ship2parts[h][3] ); 

}

//context.fillStyle="#33CCFF";
//context.fillRect(playerXPos- 100, playerYPos - 35, theme1.volume*50, 10);

/*
context.save();
context.globalAlpha = 0.3;
context.fillStyle = "blue";
context.fillRect( rectangle.x, rectangle.y, rectangle.w, rectangle.h);
context.restore();
*/

if ( circleRecttouching( circle, rectangle))
{
context.fillStyle="green";
}
else
{
context.fillStyle="Lime";
}
//context.beginPath();
//context.arc( circle.x, circle.y, circle.r, 0, 2*Math.PI);
//context.fill();
}
// this function will do its best to make stuff work at 60FPS - please notice I said "will do its best"
window.requestAnimFrame = (function(callback) {
return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
function(callback) {
window.setTimeout(callback, 50);
};
})();
// function to handle the game itself
function updateGame() {
// no friction or inertia at the moment, so at every frame initial speed is set to zero
playerXSpeed=0;
playerYSpeed += gravityForce*2;
//*0.01;
enemyYSpeed+=gravityForce1;

for (a =0; a < enemies.length; a++)
{
if (beaconarray.length > 0)
{

if ( enemies[a][0] <= beaconarray[0][0] + 200
&& beaconarray[0][0] <= enemies[a][0] + 24
&& enemies[a][1] <= beaconarray[0][1] + 10
&& beaconarray[0][1] <= enemies[0][1] + 24 )
{
enemies[a][12] = 1;
}
else
{
enemies[a][12] = 0;
}


}
}


for ( var i = 0; i < enemies.length; i++ )
{
for ( var a = 1; a < enemies.length; a++)
{

/*
if ( enemies[i][5] > 0 && enemies[i][1] < enemies[a][1] - 10 &&
enemies[i][0] <= enemies[a][0] + enemyWidth
&& enemies[a][0] <= enemies[i][0] + enemyWidth
&& enemies[i][1] <= enemies[a][1] + enemyHeight
&& enemies[a][1] <= enemies[i][1] + enemyHeight )
{
enemies[i][0] = enemies[a][0] - 33;
}


else if ( enemies[i][5] < 0 && enemies[i][1] > enemies[a][1] + 10 &&
enemies[i][0] <= enemies[a][0] + enemyWidth
&& enemies[a][0] <= enemies[i][0] + enemyWidth
&& enemies[i][1] <= enemies[a][1] + enemyHeight
&& enemies[a][1] <= enemies[i][1] + enemyHeight )
{
enemies[i][0] = enemies[a][0] + 20;
}
*/




if ( enemies[i][4] < 0 && enemies[i][0] > enemies[a][0] + 10&&
enemies[i][0] <= enemies[a][0] + enemyWidth
&& enemies[a][0] <= enemies[i][0] + enemyWidth
&& enemies[i][1] <= enemies[a][1] + enemyHeight
&& enemies[a][1] <= enemies[i][1] + enemyHeight )
{
enemies[i][0] = enemies[a][0] + 24;
enemies[i][4] = 0;
}
else if ( enemies[i][4] > 0 && enemies[i][0] < enemies[a][0] -10 &&
enemies[i][0] <= enemies[a][0] + enemyWidth
&& enemies[a][0] <= enemies[i][0] + enemyWidth
&& enemies[i][1] <= enemies[a][1] + enemyHeight
&& enemies[a][1] <= enemies[i][1] + enemyHeight )
{
enemies[i][0] = enemies[a][0] - 24;
enemies[i][4] = 0;
}
}
}
for (var i = 0; i < enemies.length; i++ )
{
enemies[i][5] += gravityForce1;
enemies[i][5] = Math.min(enemies[i][5] , maxFallingSpeed);
}
for (var i = 0; i < enemies.length; i++ )
{
enemies[i][5] += gravityForce1;
enemies[i][5] = Math.min(enemies[i][5] , maxFallingSpeed);
}
// limiting max vertical speed
playerYSpeed=Math.min(playerYSpeed,maxFallingSpeed);
//playerYSpeed=Math.max(playerYSpeed,-maxFallingSpeed);
enemyYSpeed=Math.min(enemyYSpeed,maxFallingSpeed);
enemyYSpeed=Math.max(enemyYSpeed,-maxFallingSpeed);
// updating speed according to key pressed
//&& playerlasers.length <= playerlasersTotal

if (mkeypressed && lasercount >= 5)
{
if ( playerdirection === "right")
{
lasercount= 0;

if ( skeypressed)
{
playerlasers.push([playerXPos, playerYPos - 15, laserWidth, laserHeight, 15]);
playlasersound();
}
else
{
playerlasers.push([playerXPos, Math.floor(Math.random()*(20)+ playerYPos ), laserWidth, laserHeight, 15]);
playlasersound();
}

hitarray.push([playerXPos+25, Math.floor(Math.random()*(20)+ playerYPos ), 10, 1]);
laserimagestatus = 0;
}
else if ( playerdirection === "left")
{
lasercount= 0;

if ( skeypressed)
{

playerlasers.push([playerXPos-25, playerYPos - 15, laserWidth, laserHeight, -15]);
playlasersound();
}
else
{
playerlasers.push([playerXPos-25, Math.floor(Math.random()*(20)+ playerYPos ), laserWidth, laserHeight, -15]);
playlasersound();
}	
hitarray.push([playerXPos, Math.floor(Math.random()*(20)+ playerYPos ), 10, 1]);


}

}

if (enemystatus === "attackingaliens" && enemylasers.length <= enemylasersTotal && enemylasercount >= 5 && enemyArmor > 0)
{
enemylasercount = 0;
enemylasers.push([enemyXPos- 35, Math.floor(Math.random()*(15)+ enemyYPos ) , 50, 5]);
}
if ( gravitycount >= 50 )
{
gravitycount = 0;
if (enemystatus2 === "at wall" )
{
enemyYSpeed = -25;
}
else if (playerYPos < enemyYPos )
{
enemyYSpeed = -50;
}

}

if(rightPressed){
playerXSpeed=movementSpeed
playerdirection = "right";
playerwalk+=0.3;
//playastrowalksound();
}
if
(leftPressed)
{
playerXSpeed=-movementSpeed;
playerdirection = "left";
playerwalk+=0.3;
//playastrowalksound();
}

if(upPressed)
{
/*playerYSpeed=-movementSpeed;*/

playerYSpeed = -8;
//*0.5;
}

if
( downPressed)
{

/*playerYSpeed=movementSpeed;*/
}


grenadecount += 10;
if (nkeypressed && playerdirection === "right" && grenadecount >= 300)
{
if (skeypressed )
{
playergrenades.push([playerXPos, playerYPos, -2, 10, 100, 0, "bounce" ]);
grenadecount = 0;
playnadesound();
}
else
{
playergrenades.push([playerXPos, playerYPos, -8, 5, 100]);
grenadecount = 0;
playnadesound();
}
}
else if (nkeypressed && playerdirection === "left" && grenadecount >= 300)
{
if ( skeypressed)
{
playergrenades.push([playerXPos, playerYPos, -2, -10, 100, 0, "bounce" ]);
grenadecount = 0;
playnadesound();
}
else
{
playergrenades.push([playerXPos, playerYPos, -8, -5, 100]);
grenadecount = 0;
playnadesound();
}
}

if ( pkeypressed && instructionsvisibility === "visible" && pausecount >= 50 )
{
instructionsvisibility = "notvisible";
pausecount = 0;
}
else if ( pkeypressed && instructionsvisibility === "notvisible" && pausecount >= 50 )
{
instructionsvisibility = "visible";
pausecount = 0;
}
pausecount += 1;

// updating player position
playerXPos+=playerXSpeed;
playerYPos+=playerYSpeed;
enemyXPos+=enemyXSpeed;
enemyYPos+=enemyYSpeed;
vehicleXPos += planeXSpeed;
vehicleYPos += planeYSpeed;
vehicle2XPos += plane2XSpeed;
vehicle2YPos += plane2YSpeed;
platformXPos += platformXSpeed;
offsetXamount += offsetX;
offsetYamount += offsetY;
//limiting the player camera
if ( notinplane == 1)
{
if ( playerXPos < 164 || playerXPos > 4500)
{
offsetX = 0;
}
else if ( offsetXstate==1 && playerXPos >= 164 && playerXPos <= 4500)
{
offsetX = -playerXSpeed;
}
else if ( offsetXstate==3)
{
offsetX = -platformXSpeed-playerXSpeed;
}
else
{
offsetX=0;
}
offsetY = -playerYSpeed;
}
function verticalnavigation1(XPos, YPos, XSpeed, YSpeed )
{
var baseCol1 = Math.floor(XPos/tileSize);
var baseRow1 = Math.floor(YPos/tileSize);
var colOverlap1 = XPos%tileSize>sizeDiff;
var rowOverlap1 = YPos%tileSize>sizeDiff;
if (YSpeed>0)
{
if((level[baseRow1+1][baseCol1] && !level[baseRow1][baseCol1] && rowOverlap1) || (level[baseRow1+1][baseCol1+1] && !level[baseRow1][baseCol1+1] && colOverlap1 && rowOverlap1)){
return 'verticalnav1';
//YPos = baseRow1*tileSize;
//YSpeed=0;
}
}
}
function verticalnavigation2(XPos, YPos, XSpeed, YSpeed )
{
var baseCol1 = Math.floor(XPos/tileSize);
var baseRow1 = Math.floor(YPos/tileSize);
var colOverlap1 = XPos%tileSize>sizeDiff;
var rowOverlap1 = YPos%tileSize>sizeDiff;
if(YSpeed<0){
if((!level[baseRow1+1][baseCol1] && level[baseRow1][baseCol1]) || (!level[baseRow1+1][baseCol1+1] && level[baseRow1][baseCol1+1] && colOverlap1)){
return 'verticalnav2';
//YPos = (baseRow1+1)*tileSize;
//YSpeed=0;
}
}
}
function horizontalnavigation1(XPos, YPos, XSpeed, YSpeed, status2 )
{
var baseCol1 = Math.floor(XPos/tileSize);
var baseRow1 = Math.floor(YPos/tileSize);
var colOverlap1 = XPos%tileSize>sizeDiff;
var rowOverlap1 = YPos%tileSize>sizeDiff;
if(XSpeed>0){
if((level[baseRow1][baseCol1+1] && !level[baseRow1][baseCol1] && colOverlap1) || (level[baseRow1+1][baseCol1+1] && !level[baseRow1+1][baseCol1] && rowOverlap1 && colOverlap1)){
return 'horizontalnav1';
//XPos=baseCol1*tileSize;
//status2 = "at wall";
}
else
{
status2 = "not at wall";
}
}
}
function horizontalnavigation2(XPos, YPos, XSpeed, YSpeed, status2 )
{
var baseCol1 = Math.floor(XPos/tileSize);
var baseRow1 = Math.floor(YPos/tileSize);
var colOverlap1 = XPos%tileSize>sizeDiff;
var rowOverlap1 = YPos%tileSize>sizeDiff;
if(XSpeed<0){
if((!level[baseRow1][baseCol1+1] && level[baseRow1][baseCol1]) || (!level[baseRow1+1][baseCol1+1] && level[baseRow1+1][baseCol1] && rowOverlap1)){ 
return 'horizontalnav2';
//XPos=(baseCol1+1)*tileSize;
//status2 ="at wall";
}
else
{
status2 = "not at wall";
}
}
}



for ( var i = 0; i < enemies.length; i++)
{
if (enemies[i][2] === "activesentry" )
{
if (playerXPos < enemies[i][0]-50)
{
enemies[i][4] = -1;
enemies[i][10] = "left";
}
if (playerXPos >= enemies[i][0]+ 50)
{
enemies[i][4] = 1;
enemies[i][10] = "right" ;
}
}
}




for ( var i = 0; i < enemies.length; i++ )
{
var baseCol1 = Math.floor(enemies[i][0]/tileSize);
var baseRow1 = Math.floor(enemies[i][1]/tileSize);
var colOverlap1 = enemies[i][0]%tileSize>sizeDiff;
var rowOverlap1 = enemies[i][1]%tileSize>sizeDiff;
if ( verticalnavigation1( enemies[i][0], enemies[i][1], enemies[i][4], enemies[i][5] ) === 'verticalnav1' )
{
enemies[i][1] = baseRow1*tileSize+sizeDiff;
enemies[i][5]=0;
enemies[i][9] = "onground";

enemies[i][4] *= 0.7;


}
else
{
enemies[i][9] = "notonground";
}
if ( verticalnavigation2( enemies[i][0], enemies[i][1], enemies[i][4], enemies[i][5] ) === 'verticalnav2' )
{
enemies[i][1] = (baseRow1+1)*tileSize + 10;
enemies[i][5] = 0;
}
if ( horizontalnavigation1( enemies[i][0], enemies[i][1], enemies[i][4], enemies[i][5] ) === 'horizontalnav1' )
{
enemies[i][0]=baseCol1*tileSize;
enemies[i][8] = "at wall";
}
else if ( horizontalnavigation2( enemies[i][0], enemies[i][1], enemies[i][4], enemies[i][5] ) === 'horizontalnav2' )
{
enemies[i][0]=(baseCol1+1)*tileSize;
enemies[i][8] ="at wall";
}
else
{
enemies[i][8] = "not at wall";
}
if (enemies[i][8] === "at wall" && enemies[i][9] === "onground" && playerXPos < enemies[i][0]  )
{
enemies[i][5] = -10;
}
}


// check for vertical collisions, got to do it first this time


var baseCol = Math.floor(playerXPos/tileSize);
var baseRow = Math.floor(playerYPos/tileSize);
var colOverlap = playerXPos%tileSize>sizeDiff;
var rowOverlap = playerYPos%tileSize>sizeDiff;
var baseCol1 = Math.floor(enemyXPos/tileSize);
var baseRow1 = Math.floor(enemyYPos/tileSize);
var colOverlap1 = enemyXPos%tileSize>0;
var rowOverlap1 = enemyYPos%tileSize>0;
if(playerYSpeed>0){
if((level[baseRow+1][baseCol] && !level[baseRow][baseCol] && rowOverlap) || (level[baseRow+1][baseCol+1] && !level[baseRow][baseCol+1] && colOverlap && rowOverlap )){
playerYPos = baseRow*tileSize+sizeDiff;
if (playerYSpeed > 2)
{
clouds.push([playerXPos, playerYPos + 24, 10, 1]);
clouds.push([playerXPos+24, playerYPos + 24, 10, 1]);
}

playerYSpeed=0;
offsetY= 0;

}
}

if (playerYSpeed > 0 && playerYPos <= platformYPos + 5
&& platformYPos <= playerYPos + playerSize
&& playerXPos <= platformXPos + 200
&& platformXPos <= playerXPos + playerSize)
{
if (playerYSpeed > 2)
{
clouds.push([playerXPos, playerYPos + 24, 10, 1]);
clouds.push([playerXPos+24, playerYPos + 24, 10, 1]);
}
playerXPos += platformXSpeed;
playerYPos = platformYPos - playerSize;
playerYSpeed = 0;
offsetXstate=3;
offsetY= 0;
}
else
{
offsetXstate=1;
offsetY= -playerYSpeed;
}


for ( h=0; h < ramps.length; h++)
{
platformYPos1 = ramps[h][1];
platformXPos1 = ramps[h][0];

if (playerYSpeed > 0 
&& playerYPos+20 <= platformYPos1 + 1 
&& platformYPos1 <= playerYPos + playerSize 
&& playerXPos <= platformXPos1 + 1 
&& platformXPos1 <= playerXPos + playerSize )
{
if (playerYSpeed > 2)
{

}
if ( skeypressed == false) 
{
playerYPos = platformYPos1 - playerSize;
playerYSpeed = 0;
}

if (rightPressed)
{
playerYPos -= 2;

}

if (skeypressed)
{
playerYPos += 1;
}

}
}

for ( i=0; i < allies.length; i++)
{
if (allies[i][5] > 0 && allies[i][1] <= platformYPos + 5
&& platformYPos <= allies[i][1] + 24
&& allies[i][0] <= platformXPos + 200
&& platformXPos <= allies[i][0] + 24)
{
allies[i][0] += platformXSpeed;
allies[i][1] = platformYPos - 24;
allies[i][5] = 0;
}
}

for ( i=0; i < aliens.length; i++)
{
if (aliens[i][5] > 0 && aliens[i][1] <= platformYPos + 5
&& platformYPos <= aliens[i][1] + 24
&& aliens[i][0] <= platformXPos + 200
&& platformXPos <= aliens[i][0] + 24)
{
aliens[i][0] += platformXSpeed;
aliens[i][1] = platformYPos - 24;
aliens[i][5] = 0;
}
}


for ( i=0; i < enemies.length; i++)
{
if (enemies[i][5] > 0 && enemies[i][1] <= platformYPos + 5
&& platformYPos <= enemies[i][1] + 24

&& enemies[i][0] <= platformXPos + 200 
&& platformXPos <= enemies[i][0] + 24)
{
enemies[i][0] += platformXSpeed;
enemies[i][1] = platformYPos - 24;
enemies[i][5] = 0;
}
}



if(enemyYSpeed>0){
if((level[baseRow1+1][baseCol1] && !level[baseRow1][baseCol1] && rowOverlap1) || (level[baseRow1+1][baseCol1+1] && !level[baseRow1][baseCol1+1] && colOverlap1 && rowOverlap1)){
enemyYPos = baseRow1*tileSize;
enemyYSpeed=0;
}
}
if(playerYSpeed<0){
if((!level[baseRow+1][baseCol] && level[baseRow][baseCol]) || (!level[baseRow+1][baseCol+1] && level[baseRow][baseCol+1] && colOverlap)){
playerYPos = (baseRow+1)*tileSize;
playerYSpeed=0;
offsetY = 0;
}
}
if(enemyYSpeed<0){
if((!level[baseRow1+1][baseCol1] && level[baseRow1][baseCol1]) || (!level[baseRow1+1][baseCol1+1] && level[baseRow1][baseCol1+1] && colOverlap1)){
enemyYPos = (baseRow1+1)*tileSize;
enemyYSpeed=0;
}
}
/* obstacle layer vertical */
if(playerYSpeed>0){
if((obstaclelevel[baseRow+1][baseCol] && !obstaclelevel[baseRow][baseCol] && rowOverlap) || (obstaclelevel[baseRow+1][baseCol+1] && !obstaclelevel[baseRow][baseCol+1] && colOverlap && rowOverlap)){

teleported = "true";

var playerXPos2 = playerXPos;
var playerYPos2 = playerYPos;
playerYPos = playerRow*tileSize+sizeDiff;
playerXPos = playerCol*tileSize+sizeDiff;
offsetX = playerXPos2 - playerXPos;
offsetY = playerYPos2 - playerYPos;

}
}
if(playerYSpeed<0){
if((!obstaclelevel[baseRow+1][baseCol] && obstaclelevel[baseRow][baseCol]) || (!obstaclelevel[baseRow+1][baseCol+1] && obstaclelevel[baseRow][baseCol+1] && colOverlap)){

teleported = "true";

var playerXPos2 = playerXPos;
var playerYPos2 = playerYPos;
playerYPos = playerRow*tileSize+sizeDiff;
playerXPos = playerCol*tileSize+sizeDiff;
offsetX = playerXPos2 - playerXPos;
offsetY = playerYPos2 - playerYPos;

}
}
/* win layer vertical */
if(playerYSpeed>0){
if((winlevel[baseRow+1][baseCol] && !winlevel[baseRow][baseCol] && rowOverlap) || (winlevel[baseRow+1][baseCol+1] && !winlevel[baseRow][baseCol+1] && colOverlap && rowOverlap)){
playerYPos = baseRow*tileSize+sizeDiff;
playerYSpeed = 0;
offsetY = 0;
document.getElementById('winmessage').innerHTML="You win!";
}
}
if(playerYSpeed<0){
if((!winlevel[baseRow+1][baseCol] && winlevel[baseRow][baseCol]) || (!winlevel[baseRow+1][baseCol+1] && winlevel[baseRow][baseCol+1] && colOverlap)){ 
playerYPos = (baseRow+1)*tileSize;
playerYSpeed = 0;
document.getElementById('winmessage').innerHTML="You win!";
offsetY=0;
}
}
// check for horizontal collisions
var baseCol = Math.floor(playerXPos/tileSize);
var baseRow = Math.floor(playerYPos/tileSize);
var colOverlap = playerXPos%tileSize>sizeDiff;
var rowOverlap = playerYPos%tileSize>sizeDiff;
var baseCol1 = Math.floor(enemyXPos/tileSize);
var baseRow1 = Math.floor(enemyYPos/tileSize);
var colOverlap1 = enemyXPos%tileSize>0;
var rowOverlap1 = enemyYPos%tileSize>0;

for ( h=0; h < playerlasers.length; h++)
{

var baseColL = Math.floor(playerlasers[h][0]/tileSize);
var baseRowL = Math.floor(playerlasers[h][1]/tileSize);
var colOverlapL = playerlasers[h][0]%tileSize>5;
var rowOverlapL = playerlasers[h][1]%tileSize>25;

if (playerlasers[h][4]>0){

if((level[baseRowL][baseColL+1] && !level[baseRowL][baseColL] && colOverlapL) || (level[baseRowL+1][baseColL+1] && !level[baseRowL+1][baseColL] && rowOverlapL && colOverlapL)){

//hitarray.push([playerlasers[h][0]+50, playerlasers[h][1], 10, 1]);
hitarray4.push( [playerlasers[h][0]+50, playerlasers[h][1]-(Math.random()*5) , 10]);

playerlasers.splice(h, 1);


}
}
else if (playerlasers[h][4]<0){

if((!level[baseRowL][baseColL+1] && level[baseRowL][baseColL]) || (!level[baseRowL+1][baseColL+1] && level[baseRowL+1][baseColL] && rowOverlapL)){

//hitarray.push([playerlasers[h][0]+50, playerlasers[h][1], 10, 1]);
hitarray4.push( [playerlasers[h][0]+50, playerlasers[h][1]-(Math.random()*5) , 10]);
playerlasers.splice(h, 1);
}
}

}


for (i=0; i<enemies.length; i++)
{
for (h=0; h<enemies[i][6].length; h++)
{
enemies[i][6][h][0]+=enemies[i][6][h][2];
enemies[i][6][h][1]+= enemies[i][6][h][3];

var baseColE = Math.floor(enemies[i][6][h][0]/tileSize);
var baseRowE = Math.floor(enemies[i][6][h][1]/tileSize);
var colOverlapE = enemies[i][6][h][0]%tileSize>5;
var rowOverlapE = enemies[i][6][h][1]%tileSize>25;

//if (enemies[i][6][h][2]>0){

//if((level[baseRowE][baseColE+1] && !level[baseRowE][baseColE] && colOverlapE) || (level[baseRowE+1][baseColE+1] && !level[baseRowE+1][baseColE] && //rowOverlapE && colOverlapE)){

//hitarray.push([enemies[i][6][h][0]+50, enemies[i][6][h][1], 10, 1]);
//enemies[i][6].splice(h, 1);







//}
//}
//else if (enemies[i][6][h][2]<0){

//if((!level[baseRowE][baseColE+1] && level[baseRowE][baseColE]) || (!level[baseRowE+1][baseColE+1] && level[baseRowE+1][baseColE] && rowOverlapE)){

//hitarray.push([enemies[i][6][h][0]+50, enemies[i][6][h][1], 10, 1]);
//enemies[i][6].splice(h, 1);
//}
//}


}
}


for (i=0; i<allies.length; i++)
{
for (h=0; h<allies[i][6].length; h++)
{

var baseColE = Math.floor(allies[i][6][h][0]/tileSize);
var baseRowE = Math.floor(allies[i][6][h][1]/tileSize);
var colOverlapE = allies[i][6][h][0]%tileSize>5;
var rowOverlapE = allies[i][6][h][1]%tileSize>25;

if (allies[i][6][h][2]>0){

if((level[baseRowE][baseColE+1] && !level[baseRowE][baseColE] && colOverlapE) || (level[baseRowE+1][baseColE+1] && !level[baseRowE+1][baseColE] && rowOverlapE && colOverlapE)){

hitarray.push([allies[i][6][h][0]+50, allies[i][6][h][1], 10, 1]);
allies[i][6].splice(h, 1);
}
}
else if (allies[i][6][h][2]<0){

if((!level[baseRowE][baseColE+1] && level[baseRowE][baseColE]) || (!level[baseRowE+1][baseColE+1] && level[baseRowE+1][baseColE] && rowOverlapE)){

hitarray.push([allies[i][6][h][0]+50, allies[i][6][h][1], 10, 1]);
allies[i][6].splice(h, 1);
}
}


}
}





for (i=0; i<aliens.length; i++)
{
for (h=0; h<aliens[i][6].length; h++)
{

var baseColE = Math.floor(aliens[i][6][h][0]/tileSize);
var baseRowE = Math.floor(aliens[i][6][h][1]/tileSize);
var colOverlapE = aliens[i][6][h][0]%tileSize>5;
var rowOverlapE = aliens[i][6][h][1]%tileSize>25;

if (aliens[i][6][h][2]>0){

if((level[baseRowE][baseColE+1] && !level[baseRowE][baseColE] && colOverlapE) || (level[baseRowE+1][baseColE+1] && !level[baseRowE+1][baseColE] && rowOverlapE && colOverlapE)){

hitarray.push([aliens[i][6][h][0]+50, aliens[i][6][h][1], 10, 1]);
aliens[i][6].splice(h, 1);
}
}
else if (aliens[i][6][h][2]<0){

if((!level[baseRowE][baseColE+1] && level[baseRowE][baseColE]) || (!level[baseRowE+1][baseColE+1] && level[baseRowE+1][baseColE] && rowOverlapE)){

hitarray.push([aliens[i][6][h][0]+50, aliens[i][6][h][1], 10, 1]);
aliens[i][6].splice(h, 1);
}
}


}
}




if(playerXSpeed>0){
if((level[baseRow][baseCol+1] && !level[baseRow][baseCol] && colOverlap) || (level[baseRow+1][baseCol+1] && !level[baseRow+1][baseCol] && rowOverlap && colOverlap)){
playerXPos=baseCol*tileSize+sizeDiff;
offsetXstate=2;
}
else if (offsetXstate !== 3)
{
offsetXstate=1
}
}
if(enemyXSpeed>0){
if((level[baseRow1][baseCol1+1] && !level[baseRow1][baseCol1] && colOverlap1) || (level[baseRow1+1][baseCol1+1] && !level[baseRow1+1][baseCol1] && rowOverlap1 && colOverlap1)){
enemyXPos=baseCol1*tileSize;
enemystatus2 = "at wall";
}
else
{
enemystatus2 = "not at wall";
}
}
if(playerXSpeed<0){
if((!level[baseRow][baseCol+1] && level[baseRow][baseCol]) || (!level[baseRow+1][baseCol+1] && level[baseRow+1][baseCol] && rowOverlap)){
playerXPos=(baseCol+1)*tileSize;
offsetXstate=2;
}
else if ( offsetXstate !== 3)
{
offsetXstate=1;
}
}
if(enemyXSpeed<0){
if((!level[baseRow1][baseCol1+1] && level[baseRow1][baseCol1]) || (!level[baseRow1+1][baseCol1+1] && level[baseRow1+1][baseCol1] && rowOverlap1)){ 
enemyXPos=(baseCol1+1)*tileSize;
enemystatus2 ="at wall";
}
else
{
enemystatus2 = "not at wall";
}
}
/* obstacle layer horizontal */
if(playerXSpeed>0){
if((obstaclelevel[baseRow][baseCol+1] && !obstaclelevel[baseRow][baseCol] && colOverlap) || (obstaclelevel[baseRow+1][baseCol+1] && !obstaclelevel[baseRow+1][baseCol] && rowOverlap && colOverlap)){



var playerXPos2 = playerXPos;
var playerYPos2 = playerYPos;
playerYPos = playerRow*tileSize+sizeDiff;
playerXPos = playerCol*tileSize+sizeDiff;

teleported = "true";

offsetX = playerXPos2 - playerXPos;
offsetY = playerYPos2 - playerYPos;

}
}
if(playerXSpeed<0){
if((!obstaclelevel[baseRow][baseCol+1] && obstaclelevel[baseRow][baseCol]) || (!obstaclelevel[baseRow+1][baseCol+1] && obstaclelevel[baseRow+1][baseCol] && rowOverlap)){

teleported = "true";

var playerXPos2 = playerXPos;
var playerYPos2 = playerYPos;
playerYPos = playerRow*tileSize+sizeDiff;
playerXPos = playerCol*tileSize+sizeDiff;
offsetX = playerXPos2 - playerXPos;
offsetY = playerYPos2 - playerYPos;

}
}
/* win layer horizontal */
if(playerXSpeed>0){
if((winlevel[baseRow][baseCol+1] && !winlevel[baseRow][baseCol] && colOverlap) || (winlevel[baseRow+1][baseCol+1] && !winlevel[baseRow+1][baseCol] && rowOverlap && colOverlap)){
document.getElementById('winmessage').innerHTML="You win!";
offsetX=0;
playerXPos = baseCol*tileSize+sizeDiff;
}
}
if(playerXSpeed<0){
if((!winlevel[baseRow][baseCol+1] && winlevel[baseRow][baseCol]) || (!winlevel[baseRow+1][baseCol+1] && winlevel[baseRow+1][baseCol] && rowOverlap)){
document.getElementById('winmessage').innerHTML="You win!";
offsetX=0;
playerXPos = (baseCol+1)*tileSize;
}
}
// player laser movement
for (var h=0; h < playerlasers.length; h++)
{
playerlasers[h][0] += playerlasers[h][4];
if ( playerlasers[h][0] > playerXPos+800 || playerlasers[h][0] < playerXPos-800)
{
//hitarray.push([playerlasers[h][0]+50, playerlasers[h][1], 10, 1]);
hitarray4.push( [playerlasers[h][0]+50, playerlasers[h][1]-(Math.random()*5) , 10]);

playerlasers.splice(h, 1);
//enemiesTotal -= 1;
}
}
for ( var a = 0; a < enemies.length; a++)
{
for (var h = 0; h < playerlasers.length; h++)
{
if ( playerlasers[h][0] <= enemies[a][0] + enemyWidth
&& enemies[a][0] <= playerlasers[h][0] + laserWidth
&& playerlasers[h][1] <= enemies[a][1] + enemyHeight
&& enemies[a][1] <= playerlasers[h][1] + laserHeight )
{
//hitarray.push([playerlasers[h][0]+ 50, playerlasers[h][1], 10, 1]);
hitarray4.push( [playerlasers[h][0]+50, playerlasers[h][1]-(Math.random()*5) , 10]);

playerlasers.splice(h, 1);
enemies[a][3] -= 10;
}
}
}
for ( var a = 0; a < enemies.length; a++)
{
for (var h = 0; h < cannonarray.length; h++)
{
if ( cannonarray[h][0] <= enemies[a][0] + enemyWidth
&& enemies[a][0] <= cannonarray[h][0] + 10
&& cannonarray[h][1] <= enemies[a][1] + enemyHeight
&& enemies[a][1] <= cannonarray[h][1] + 5 )
{
//hitarray.push([cannonarray[h][0]+ 50, cannonarray[h][1], 10, 1]);

cannonarray.splice(h, 1);
enemies[a][3] -= 5;
}
}
}
for ( var a = 0; a < enemies.length ; a++)
{
if ( enemies[a][3] <= 0 )
{
if (enemies[a][11] === "I'm the leader" )
{
alienleaderchosen = 0;
if (beaconarray.length > 0)
{
beaconarray.splice(0, 1);
}

}
enemies.splice(a, 1);
playaliensound();
}
}
lasercount+=1;
//enemy status
if ( playerXPos > enemyXPos - 350 && playerYPos > enemyYPos - 350)
{
enemystatus3 = "activesentry";
}
if (playerXPos >= enemyXPos - 250 && playerYPos < enemyYPos + 50 && playerYPos > enemyYPos - 50 && enemystatus3 === "activesentry" )
{
enemystatus = "attackingaliens";
}
else
{
enemystatus = "patrollingforaliens";
}
gravitycount+=1;
//enemy laser movement
for (var i=0; i < enemylasers.length; i++)
{
if (enemylasers[i][0] < 1)
{
enemylasers.splice(i, 1);
}
else if
( enemylasers[i][0] <= playerXPos + playerSize
&& playerXPos <= enemylasers[i][0] + 50
&& enemylasers[i][1] <= playerYPos + playerSize
&& playerYPos <= enemylasers[i][1] + 5 )
{
//playerArmor -= 1;
enemylasers.splice(i, 1);
}
else if (enemylasers[i][0] > 0)
{
enemylasers[i][0] -= 10;
}
}
enemylasercount += 1;
//other alien movement
//alien x movement
if ( controlpoints.length > 0 )
{
if (controlpoints[1][2] >= 100)
{
if (alienXPos < playerXPos - 45)
{
alienXPos+=1;
}
else if(alienXPos > playerXPos + 45)
{
alienXPos-=1;
}
else
{
alienXPos = alienXPos;
}
//alien y movement
if (alienYPos < playerYPos - 45)
{
alienYPos+=1;
}
else if(alienYPos > playerYPos + 45)
{
alienYPos-=1;
}
else
{
alienYPos = alienYPos;
}
if (playerArmor < 100 && playerYPos <= alienYPos + 120
&& playerYPos >= alienYPos -120
&& playerXPos <= alienXPos + 120
&& playerXPos >= alienXPos - 120)
{
alienstatus = "healingplayer";
if (playerArmor < 100 )
{
playerArmor += 5;
}
}
else
{
alienstatus = "guarding";
}
}
}
if (enemyArmor <= 0)
{
enemyXPos = 0;
enemyYPos = 0;
}
if (enemystatus3 === "activesentry" )
{
if (playerXPos < enemyXPos)
{
enemyXSpeed = -1;
}
else if (playerXPos >= enemyXPos)
{
enemyXSpeed = 1;
}
}

/*
if (platformXSpeed == 0 && platformXPos < 400)
{
platformXSpeed = 1;
}
else if(platformXPos == 200 && platformXSpeed == 1)
{
platformXSpeed = -1;
}
else if (platformXPos == 100 && platformXSpeed == -1)
{
platformXSpeed = 1;
}
*/

/* if the player's health is less than 100, the alien will heal the player */
/* light navigation when the alien is healing the player */
/* if the light touches the player, send the light back to the alien */
/*
if (lightXPos <= playerXPos + playerSize
&& playerXPos <= lightXPos + 15
&& lightYPos <= playerYPos + playerSize
&& playerYPos <= lightYPos + 15 )
{
lightXPos = alienXPos;
lightYPos = alienYPos;
}
*/
/*
if (lightXPos <= playerXPos )
{
lightXPos += 5;
}
if ( lightXPos >= playerXPos )
{
lightXPos -= 5;
}
if (lightYPos <= playerYPos )
{
lightYPos += 5;
}
if ( lightYPos >= playerYPos)
{
lightYPos -= 5;
}
*/
/* if the player if fully healed, no need to heal more */
if (playerArmor >= 100)
{
playerArmor = 100;
alienstatus = "guarding";
}
if (planeXSpeed == 0)
{
planeXSpeed = -3;
}
if ( vehicleXPos <= -100)
{
vehicleXPos = 900;
}
else if ( vehicleXPos >= 1000)
{
vehicleXPos = -140;
}
if ( skeypressed && playerArmor >= 1050)
{
plane2XSpeed = 1;
plane2RotationSpeed = 10;
}
else
{
plane2XSpeed = 0;
plane2RotationSpeed = 0;
}
if ( vehicle2XPos <= -100)
{
vehicle2XPos = 900;
}
else if ( vehicle2XPos >= 1200)
{
vehicle2XPos = -90;
}
if ( vehicle2YPos <= 0 )
{
vehicle2YPos = 500;
}
else if ( vehicle2YPos >= 1150)
{
vehicleYPos = 10;
}
if ( vehicle2YPos + 500 < vehicleYPos )
{
plane2YSpeed += 0.1;
if ( plane2YSpeed >= 1)
{
plane2YSpeed = 1;
}
}
if ( vehicle2YPos > vehicleYPos + 500)
{
plane2YSpeed -= 0.1;
if ( plane2YSpeed <= -1)
{
plane2YSpeed = -1;
}
}
if ( plane2Rotation <= 20)
{
plane2Rotation += 0.25;
}
/* plane rotation function */
//transparent box
//var hitarray = [];
//where ever the enemy is hit, draw an explosion once
//when the splice() function is used, draw an explosion at the location
// each square will have a x co-ord, a y- co-ord, a size, and an alpha value;
//hitarray.push([laserX, laserY, size, alpha]);
//hitarray.push([laserX, laserY, 10, 1]);
//for (i = 0; i < hitarray.length; i++)
//{
//hitarray[i][2] += 1;
//hitarray[i][3] -= 0.01;
//context.fillStyle = "rgba(235, 125, 0, " + hitarray[i][3] + ")";
//context.fillRect( hitarray[i][0]-hitarray[i][2]/2, hitarray[i][1]-hitarray[i][2]/2, hitarray[i][2], hitarray[i][2] );
//if ( hitarray[i][3] <= 0)
//{
//hitarray.splice(i, 1);
//}
//}
if (playerArmor >= 100)
{
spawnenemy = "active";
}
if (spawnenemy === "active" && enemies.length < 10 && numberofenemies < 10)
{
numberofenemies += 1;
enemies.push([numberofenemies*30 + 900, 50, "sentry", 25, 0, 0, [], 0, 0, 0, "right", "aliensoldier" ]); 
enemies.push([numberofenemies*30 + 3500, 350, "sentry", 25, 0, 0, [], 0, 0, 0, "right", "aliensoldier" ]); 
}



for ( var i=0; i < enemies.length; i++)
{
for ( var j=0; j < enemies[i][6].length; j++)
{
for ( var s=0; s < allies.length; s++)
{
allies[s][12]=allies[s][0]; 

if (enemies[i][6][j] != undefined)
{
if (enemies[i][6][j][0] <= allies[s][12] + playerSize
&& allies[s][12] <= enemies[i][6][j][0] +laserWidth
&& enemies[i][6][j][1] <= allies[s][1] + playerSize
&& allies[s][1] <= enemies[i][6][j][1] + laserHeight )
{

enemies[i][6].splice( j, 1); 
allies[s][11] -= 1;
} 

}

}}}



for ( var i=0; i < enemies.length; i++)
{
for ( var j=0; j < enemies[i][6].length; j++)
{
for ( var s=0; s < aliens.length; s++)
{
aliens[s][12]=aliens[s][0]; 

if (enemies[i][6][j] != undefined)
{
if (enemies[i][6][j][0] <= aliens[s][12] + playerSize
&& aliens[s][12] <= enemies[i][6][j][0] +laserWidth
&& enemies[i][6][j][1] <= aliens[s][1] + playerSize
&& aliens[s][1] <= enemies[i][6][j][1] + laserHeight )
{

enemies[i][6].splice( j, 1); 
aliens[s][11] -= 1;
} 

}

}}}


//enemy character movement
for ( var i = 0; i < enemies.length; i++)
{


enemies[i][0]+=enemies[i][4];
enemies[i][1]+=enemies[i][5];


if (playerXPos >= enemies[i][0] - 450 && playerXPos <= enemies [i][0] + 280
&& playerYPos >= enemies[i][1] -200 && playerYPos <= enemies[i][1] + 280 && playerstealth == "uncloaked" && enemies[i][11] !== "I'm the leader")
{
enemies[i][2] = "activesentry";
}
else
{
enemies[i][2] = "sentry";
}
enemies[i][7]+=1;
if (enemies[i][2] === "activesentry" && enemies[i][6].length < 5 && enemies[i][7] >= 15 && enemies[i][1] < 500  )
{
if ( playerXPos <= enemies[i][0] && playerYPos <= enemies[i][1]+30 && enemies[i][1] <= playerYPos + 30)
{
enemies[i][6].push([enemies[i][0]-25, Math.floor(Math.random()*(20))+enemies[i][1], -15, 0]);
hitarray2.push([ enemies[i][0], Math.floor(Math.random()*(20))+enemies[i][1],10, 1]);
enemies[i][7] = 0;
}
if ( playerXPos >= enemies[i][0] && playerYPos <= enemies[i][1]+30 && enemies[i][1] <= playerYPos + 30)
{
enemies[i][6].push([enemies[i][0], Math.floor(Math.random()*(20))+enemies[i][1], 15, 0]);
hitarray2.push([enemies[i][0]+20, Math.floor(Math.random()*(20))+enemies[i][1], 10, 1]);
enemies[i][7] = 0;
}
}

for ( var j=0; j < enemies[i][6].length; j++)
{


if (enemies[i][6][j][0] <= 0 || enemies[i][6][j][0] >= 3150 )
{
enemies[i][6].splice( j, 1);
}
else if (enemies[i][6][j][0] <= playerXPos + playerSize
&& playerXPos <= enemies[i][6][j][0] + laserWidth
&& enemies[i][6][j][1] <= playerYPos + playerSize
&& playerYPos <= enemies[i][6][j][1] + laserHeight )
{
enemies[i][6].splice( j, 1);

if (playerShields > 0)
{
playerShields -= 1;
}
else if ( playerShields <= 0 )
{
playerArmor -= 1;
}
}
}
}

for (i = 0; i < enemies.length; i++)
{
for (h = 0; h < enemies[i][6].length; h++)
{
for ( a = 0; a < levelRows; a++)
{
for ( b = 0; b < levelCols; b++)
{
if ( level[a][b] != 0)
{

var elr = enemies[i][6][h]
if ( elr)
{
if ( elr[0] <= b*32 + 32
&& b*32 <= elr[0] + 25
&& elr[1] <= a*32 + 32
&& a*32 <= elr[1] + 5 )
{
enemies[i][6].splice(h, 1);
}

}
}
}
}
}
}


for (h = 0; h < warriorlasers.length; h++)
{
for ( a = 0; a < levelRows; a++)
{
for ( b = 0; b < levelCols; b++)
{
if ( level[a][b] != 0)
{

var elr = warriorlasers[h];
if ( elr)
{
if ( elr[0] <= b*32 + 32
&& b*32 <= elr[0] + 1
&& elr[1] <= a*32 + 32
&& a*32 <= elr[1] + 1 )
{
hitarray4.push([elr[0], elr[1], 10, 1]);
warriorlasers.splice(h, 1);
}

}
}
}
}
}



for ( var s=0; s < allies.length; s++)
{
if (allies[s][11] <= 0)
{
allies.splice( s,1);
}
}

for ( var s=0; s < aliens.length; s++)
{
if (aliens[s][11] <= 0)
{
aliens.splice( s,1);
}
}


if ( playerArmor >= 100 && controlpoints.length < numberofcontrolpoints)
{
for(var i = 0; i < numberofcontrolpoints; i++)
{
if ( i < 1 )
{
controlpoints.push([i*300 + 200, 445, 10]);
}
else if ( i < 2 )
{
controlpoints.push([i*300 + 200, 250, 10]);
}
else
{
controlpoints.push([i*300 + 50, 445, 10]);
}
}
}
for (var i = 0; i < controlpoints.length ; i++)
{
if ( playerXPos <= controlpoints[i][0] + 100
&& controlpoints[i][0] <= playerXPos + playerSize
&& playerYPos <= controlpoints[i][1] + 10
&& controlpoints[i][1] <= playerYPos + playerSize
&& controlpoints[i][2] < 100)
{
controlpoints[i][2]+= 1;
}
}


var offsetXamountdifference = ((offsetXamount+playerXPos+(playerCol*tileSize+sizeDiff/2))-428);
var offsetYamountdifference = ((offsetYamount +(playerRow*tileSize+sizeDiff/
2)+ playerYPos)-264);


// correcting the camera offset
if ( playerXPos >= 260 && playerXPos <= 4500  )
{
if ( Math.floor(offsetXamountdifference) !== 0)
{
offsetX -= Math.floor(offsetXamountdifference);

}
}
else
{
offsetX = 0;
}

if ( teleported == "true"  )
{
if ( Math.floor(offsetXamountdifference) !== 0)
{
teleported = "false";
offsetX -= Math.floor(offsetXamountdifference) + 100;
}

}





if ( Math.floor(offsetYamountdifference) !== 0)
{
offsetY -= Math.floor(offsetYamountdifference);
}


if ( instructionsvisibility === "visible" )
{
document.getElementById('instructions').style.visibility = "visible";
}
else if ( instructionsvisibility === "notvisible" )
{
document.getElementById('instructions').style.visibility = "hidden";
}

if ( allies.length < 5 && numberofallies < 5)
{
numberofallies+=1;
allies.push([Math.random()*100+2000, 300, "sentry", 50, 0, 0, [], 0, 0, 0, "right", 25, 0, 0]);
}

for ( var i = 0; i < allies.length; i++ )
{
allies[i][0] += allies[i][4];
allies[i][1] += allies[i][5];
if ( allies[i][1] >= 430)
{
allies[i][1] = 430;
}
}

for ( var i = 0; i < aliens.length; i++ )
{
aliens[i][0] += aliens[i][4];
aliens[i][1] += aliens[i][5];
if ( aliens[i][1] >= 430)
{
aliens[i][1] = 430;
}
}


for ( var i = 0; i < allies.length; i++ )
{
if (allies[i][2] === "activesentry" && playerstealth === "uncloaked" )
{

if ( allies[1])
{
medichere = "active";
}
else
{
medichere = "inactive";
}

if (playerXPos < allies[i][0]-50)
{
allies[i][4] = -3;
allies[i][10] = "left";
}
else if (playerXPos > allies[i][0]+ 50)
{
allies[i][4] = 3;
allies[i][10] = "right" ;
}
else
{
allies[i][4] = 0;
}

}
}





for ( var i = 0; i < allies.length; i++ )
{
for ( var a = 0; a < allies.length; a++)
{
var alliestogether = (allies[i][0] <= allies[a][0] + allyWidth
&& allies[a][0] <= allies[i][0] + allyWidth
&& allies[i][1] <= allies[a][1] + allyHeight
&& allies[a][1] <= allies[i][1] + allyHeight );
if ( i !== a )
{
/*
if ( allies[i][5] > 0 && allies[i][1] <= allies[a][1] &&
alliestogether )
{
allies[i][1] = allies[a][1] - 24;
allies[i][5] = 0;
allies[i][9] = "onground";
}
else if ( allies[i][5] < 0 && allies[i][1] >= allies[a][1] &&
alliestogether )
{
allies[i][5] = 0;
}
*/
if ( allies[i][4] < 0 && allies[i][0] >= allies[a][0] &&
alliestogether )
{
//allies[i][0] = allies[a][0] + 43;
allies[i][4] = 0;
}
else if ( allies[i][4] > 0 && allies[i][0] <= allies[a][0] &&
alliestogether )
{
//allies[i][0] = allies[a][0] - 43;
allies[i][4] = 0;
}
}
}
}






for ( var i = 0; i < allies.length; i++)
{
if (playerXPos >= allies[i][0] - 150 && playerXPos <= allies [i][0] + 180
&& playerYPos >= allies[i][1] -50 && playerYPos <= allies[i][1] + 90)
{
allies[i][2] = "activesentry";
}
else
{
allies[i][2] = "sentry";
}
}


for ( var i = 0; i < aliens.length; i++)
{
if (playerXPos >= aliens[i][0] - 150 && playerXPos <= aliens [i][0] + 180
&& playerYPos >= aliens[i][1] -50 && playerYPos <= aliens[i][1] + 90)
{
aliens[i][2] = "activesentry";
}
else
{
aliens[i][2] = "sentry";
}
}

for ( var i = 0; i < allies.length; i++ )
{
allies[i][7] += 1;
for ( var a = 0; a < enemies.length; a++)
{
if ( allies[i][7] >= 10
&& enemies[a][0] <= allies[i][0] + 450
&& allies[i][0] - 340 <= enemies[a][0]
&& enemies[a][1] <= allies[i][1] + 30
&& allies[i][1] <= enemies[a][1] +30)
{
if ( enemies[a][0] <= allies[i][0] )
{
allies[i][6].push([allies[i][0]-35, (Math.random()*(20))+allies[i][1], -15, 0]);
hitarray.push([ allies[i][0], (Math.random()*(20))+ allies[i][1],10, 1]);
allies[i][7] = 0;
allies[i][10] = "left";
}
if ( enemies[a][0] >= allies[i][0] )
{
allies[i][6].push([allies[i][0], (Math.random()*(20))+allies[i][1], 15, 0]);
hitarray.push([allies[i][0]+20, (Math.random()*(20))+ allies[i][1], 10, 1]);
allies[i][7] = 0;
allies[i][10] = "right";
}
}
}
}


for ( var i = 0; i < aliens.length; i++ )
{
aliens[i][7] += 1;
for ( var a = 0; a < enemies.length; a++)
{
if ( aliens[i][7] >= 10
&& enemies[a][0] <= aliens[i][0] + 450
&& aliens[i][0] - 340 <= enemies[a][0]
&& enemies[a][1] <= aliens[i][1] + 30
&& aliens[i][1] <= enemies[a][1] +30 )
{
if ( enemies[a][0] <= aliens[i][0] )
{
aliens[i][6].push([aliens[i][0]-35, (Math.random()*(20))+aliens[i][1], -15, 0]);
hitarray.push([ aliens[i][0], (Math.random()*(20))+ aliens[i][1],10, 1]);
aliens[i][7] = 0;
aliens[i][10] = "left";
}
if ( enemies[a][0] >= aliens[i][0] )
{
aliens[i][6].push([aliens[i][0], (Math.random()*(20))+aliens[i][1], 15, 0]);
hitarray.push([aliens[i][0]+20, (Math.random()*(20))+ aliens[i][1], 10, 1]);
aliens[i][7] = 0;
aliens[i][10] = "right";
}
}
}
}




for ( var i = 0; i < allies.length; i++)
{
for ( var a = 0; a < enemies.length; a++ )
{
for ( var j = 0; j < allies[i][6].length; j ++ )
{
if (allies[i][6][j][0] <= enemies[a][0] + enemyWidth
&& enemies[a][0] <= allies[i][6][j][0] + laserWidth
&& allies[i][6][j][1] <= enemies[a][1] + enemyHeight
&& enemies[a][1] <= allies[i][6][j][1] + laserHeight )
{
allies[i][6].splice( j, 1);
enemies[a][3] -= 1;
}
}
}
}


for ( var i = 0; i < aliens.length; i++)
{
for ( var a = 0; a < enemies.length; a++ )
{
for ( var j = 0; j < aliens[i][6].length; j ++ )
{
if (aliens[i][6][j][0] <= enemies[a][0] + enemyWidth
&& enemies[a][0] <= aliens[i][6][j][0] + laserWidth
&& aliens[i][6][j][1] <= enemies[a][1] + enemyHeight
&& enemies[a][1] <= aliens[i][6][j][1] + laserHeight )
{
aliens[i][6].splice( j, 1);
enemies[a][3] -= 1;
}
}
}
}




for ( var i = 0; i < allies.length; i++ )
{
for ( var j = 0; j < allies[i][6].length; j ++ )
{
allies[i][6][j][0]+=allies[i][6][j][2];
allies[i][6][j][1]+= allies[i][6][j][3];
if (allies[i][6][j][0] <= 0 || allies[i][6][j][0] >= 3150 )
{
allies[i][6].splice( j, 1);
}
}
}


for ( var i = 0; i < aliens.length; i++ )
{
for ( var j = 0; j < aliens[i][6].length; j ++ )
{
aliens[i][6][j][0]+=aliens[i][6][j][2];
aliens[i][6][j][1]+= aliens[i][6][j][3];
if (aliens[i][6][j][0] <= 0 || aliens[i][6][j][0] >= 3150 )
{
aliens[i][6].splice( j, 1);
}
}
}



for ( var i = 0; i < allies.length; i++ )
{
var baseCol1 = Math.floor(allies[i][0]/tileSize);
var baseRow1 = Math.floor(allies[i][1]/tileSize);
var colOverlap1 = allies[i][0]%tileSize>sizeDiff;
var rowOverlap1 = allies[i][1]%tileSize>sizeDiff;
if ( verticalnavigation1( allies[i][0], allies[i][1], allies[i][4], allies[i][5] ) === 'verticalnav1' ) 
{
allies[i][1] = baseRow1*tileSize+sizeDiff;
allies[i][5]=0;
allies[i][9] = "onground";
}
else
{
allies[i][9] = "notonground";
}
if ( verticalnavigation2( allies[i][0], allies[i][1], allies[i][4], allies[i][5] ) === 'verticalnav2' ) 
{
allies[i][1] = (baseRow1+1)*tileSize;
allies[i][5] = 0;
}
if ( horizontalnavigation1( allies[i][0], allies[i][1], allies[i][4], allies[i][5] ) === 'horizontalnav1' )
{
allies[i][0]=baseCol1*tileSize;
allies[i][8] = "at wall";
}
else if ( horizontalnavigation2( allies[i][0], allies[i][1], allies[i][4], allies[i][5] ) === 'horizontalnav2' )
{
allies[i][0]=(baseCol1+1)*tileSize;
allies[i][8] ="at wall";
}
else
{
allies[i][8] = "not at wall";
}





if (allies[i][8] === "at wall" && allies[i][9] === "onground"   )
{

if (
allies[i][0] < 100 || allies[i][0] > 2900
)
{
allies[i][5] = 0;
allies[i][4] = 0;
}
else
{
allies[i][5] = -15;
}

}
else if ( playerYPos < allies[i][1] && allies[i][9] === "onground" && allies[i][2] === "activesentry"  )
{


allies[i][5] = -10;



}
allies[i][5] += gravityForce1;
allies[i][5] = Math.min(allies[i][5] , maxFallingSpeed);

if ( baseCol1 == 1 && baseRow1 == 6)
{
allies[i][5] = -15;

}

if ( baseCol1 == 1 && baseRow1 <= 2)
{
allies[i][4] = 3;
}

}


for ( var i = 0; i < aliens.length; i++ )
{
var baseCol1 = Math.floor(aliens[i][0]/tileSize);
var baseRow1 = Math.floor(aliens[i][1]/tileSize);
var colOverlap1 = aliens[i][0]%tileSize>sizeDiff;
var rowOverlap1 = aliens[i][1]%tileSize>sizeDiff;
if ( verticalnavigation1( aliens[i][0], aliens[i][1], aliens[i][4], aliens[i][5] ) === 'verticalnav1' ) 
{
aliens[i][1] = baseRow1*tileSize+sizeDiff;
aliens[i][5]=0;
aliens[i][9] = "onground";
}
else
{
aliens[i][9] = "notonground";
}
if ( verticalnavigation2( aliens[i][0], aliens[i][1], aliens[i][4], aliens[i][5] ) === 'verticalnav2' ) 
{
aliens[i][1] = (baseRow1+1)*tileSize;
aliens[i][5] = 0;
}
if ( horizontalnavigation1( aliens[i][0], aliens[i][1], aliens[i][4], aliens[i][5] ) === 'horizontalnav1' )
{
aliens[i][0]=baseCol1*tileSize;
aliens[i][8] = "at wall";
}
else if ( horizontalnavigation2( aliens[i][0], aliens[i][1], aliens[i][4], aliens[i][5] ) === 'horizontalnav2' )
{
aliens[i][0]=(baseCol1+1)*tileSize;
aliens[i][8] ="at wall";
}
else
{
aliens[i][8] = "not at wall";
}
if (aliens[i][8] === "at wall" && aliens[i][9] === "onground")
{
aliens[i][5] = -15;
}
else if ( playerYPos < aliens[i][1] && aliens[i][9] === "onground" && aliens[i][2] === "inactivesentry" )
{
aliens[i][5] = -10;
}
aliens[i][5] += gravityForce1;
aliens[i][5] = Math.min(aliens[i][5] , maxFallingSpeed);
}


for (i=0; i<  aliens.length; i++)
{
if (aliens[i][0] > 1200)
{
aliens[i][4] = -3;
}
var baseCol1 = Math.floor(aliens[i][0]/tileSize);
var baseRow1 = Math.floor(aliens[i][1]/tileSize);
if (baseCol1 == 52 && baseRow1 == 10)
{
aliens[i][5] = 10;

}
if ( (baseCol1 == 33 && baseRow1 == 6) || (baseCol1 == 33 && baseRow1 == 5) )
{
aliens[i][4] = 0;
}

}



for ( var i = 0; i < aliens.length; i++ )
{
if (aliens[i][2] === "activesentry" && playerstealth === "uncloaked" )
{

if (playerXPos < aliens[i][0]-50)
{
aliens[i][4] = -3;
aliens[i][10] = "left";
}
else if (playerXPos > aliens[i][0]+ 50)
{
aliens[i][4] = 3;
aliens[i][10] = "right" ;
}
else
{
aliens[i][4] = 0;
}

}
}
var a;
for ( var i = 0; i < aliens.length; i++ )
{
for ( a= i+1 ; a < aliens.length; a++)
{
var alienstogether = (aliens[i][0] <= aliens[a][0] + allyWidth
&& aliens[a][0] <= aliens[i][0] + allyWidth
&& aliens[i][1] <= aliens[a][1] + allyHeight
&& aliens[a][1] <= aliens[i][1] + allyHeight );


if ( aliens[i][4] < 0 && aliens[i][0] >= aliens[a][0] &&
alienstogether )
{
//aliens[i][0] = aliens[a][0] + 43;
aliens[i][4] = 0;
}
else if ( aliens[i][4] > 0 && aliens[i][0] <= aliens[a][0] &&
alienstogether )
{
//aliens[i][0] = aliens[a][0] - 43;
aliens[i][4] = 0;
}

}
}


if ( sparkcount >= 20 && controlpoints[2][2] < 100)
{
sparkarray.push([750, 450, Math.random()*5, -Math.random()*2 +(-1), 20, 2, "yellow" ]);
}
if ( controlpoints[2][2] >= 100 && lightImage2progress < 60)
{
sparkarray.push([835, 360+lightImage2progress, Math.random()*5+-2.5, -Math.random()*2 +(-1), 20, 2, "white"]);
}

var color1 = "#FFFF00";
var color2 = "#FFCC00";
var color3 = "#FF9900";
var color4 = "#FF6600";
var color5 = "#FF3300";
var color6 = "#990000";


for (h=0; h < playergrenades.length; h++)
{

sparkarray.push([playergrenades[h][0] + 10*Math.random(), playergrenades[h][1], Math.random()*2+-1, -Math.random()*4 +(-2), 15, 5, "cyan"]);

}

for ( var i = 0; i < sparkarray.length; i++)
{
sparkarray[i][0] += sparkarray[i][2];
sparkarray[i][1] += sparkarray[i][3];
sparkarray[i][3] += gravityForce/2;
sparkarray[i][4] -= 1;

if ( sparkarray[i][5] == 5)
{
sparkarray[i][4] -= 0.2*Math.random();


if ( sparkarray[i][4] > 12)
{
sparkarray[i][6] = color1;
}
else if ( sparkarray[i][4] > 9)
{
sparkarray[i][6] = color2;
}
else if ( sparkarray[i][4] > 7)
{
sparkarray[i][6] = color3;
}
else if ( sparkarray[i][4] > 5)
{
sparkarray[i][6] = color4;
}
else if ( sparkarray[i][4] > 4)
{
sparkarray[i][6] = color5;
}
else if ( sparkarray[i][4] > 3)
{
sparkarray[i][6] = color6;
}
}

if ( sparkarray[i][4] < 0 )
{
sparkarray.splice(i, 1);
}
}
sparkcount += 1;



//for ( h = 0; h < enemies.length; h++)
//{
//if ( enemies[h][0] < plane3XPos + 250)
//{

//if (enemies[h][1] < plane3YPos - 100)
//{
//cannonRotation -= 0.5;
//planeRotation -= 3;
//}
//else if (enemies[h][1] > plane3YPos -100 )
//{
//cannonRotation += 0.5;
//planeRotation += 3;
//}

//}
//}

if ( skeypressed && thrust < 2 && playerArmor > 1050)
{
thrust +=1;
}
var planeRotation1 = planeRotation *Math.PI/180;
if (planeXSpeed > 0)
{
planeXSpeed -= 0.1;
}
//forceX = Math.cos(planeRotation1)*Math.abs(thrust);
//lift= (Math.sin(planeRotation1)+ 0.2)*Math.sqrt((plane3XSpeed)*
//
//(plane3XSpeed) + (plane3YSpeed)*(plane3YSpeed) );
//plane3XSpeed = forceX;
//plane3YSpeed = lift+gravityForce;
//plane3YSpeed += gravityForce*5;
plane3XSpeed = Math.cos(planeRotation1)*thrust;
plane3YSpeed = Math.sin(planeRotation1)*thrust;
plane3YSpeed += 0.2;
plane3XPos += plane3XSpeed;
plane3YPos += plane3YSpeed;
if ( plane3YPos >= 390)
{
plane3YPos = 390;
plane3YSpeed = 0;
if ( notinplane == 2)
{
context.translate(0, plane3YSpeed);
}
}

var cannonRotation1 = cannonRotation*Math.PI/180;
for ( var i = 0; i < cannonarray.length; i++ )
{
cannonarray[i][0] += cannonarray[i][2];
cannonarray[i][1] += cannonarray[i][3];
if ( cannonarray[i][0] >= 2800 || cannonarray[i][0] <= 0 || cannonarray[i][1] <= 0 || cannonarray[i][1] >= 430 )
{
//hitarray.push([ cannonarray[i][0], cannonarray[i][1], 10, 1 ]);

laserexplosions.push([ cannonarray[i][0], cannonarray[i][1], 0]);

cannonarray.splice( i, 1);

}
}
cannonXPos1 += cannonvar2;
cannonvar1 += 1;
if ( cannonXPos1 >= 100)
{
cannonXPos1 = 100;
cannonvar2 = 0;
}
if ( cannonXPos1 < 50)
{
cannonvar2 = 1;
}
var r1 = planeRotation+20*Math.random()-10;
var planeRotation1 = (r1 )*Math.PI/180;


for ( h = 0; h < enemies.length; h++)
{
if ( enemies[h][0] < plane3XPos + 550 && enemies[h][1] > plane3YPos - 100 )
{

if ( 
cannonvar1 >= 5 
)
{
var rand=Math.random();
flarearray.push([ Math.floor(rand*3) , 3] );
//cannonarray.push([ plane3XPos, plane3YPos, Math.cos(planeRotation1)*20, //Math.sin(planeRotation1)*20, r1]);

//cannonarray.push([ plane3XPos+ 25, plane3YPos -15 + Math.floor(rand*3)*15, //20, 0, 0 ]);

var rad1 = cannonRotation * Math.PI/180;

blastercount+=1;



cannonvar1 = 0;
//cannonvar2 = -20;
}

}
}

if (blastercount >= 1.5)
{
blastercount = 0;
}


if (skeypressed && playerArmor > 1050)
{
notinplane=2;
}
if ( notinplane== 2)
{
offsetX = -plane3XSpeed;
offsetY = -plane3YSpeed;
}
if ( glowArray.length < numberofglowParticles)
{
glowArray.push([Math.random()*50+1600, Math.random()*450, Math.random()*0.5, Math.random()*0.5 ]);
}
for ( var i = 0; i < glowArray.length; i++)
{
glowArray[i][0] += glowArray[i][2];
glowArray[i][1] += glowArray[i][3];
if ( glowArray[i][0] <= 1600 || glowArray[i][0] >= 3000)
{
glowArray[i][2] *= -1;
}
if ( glowArray[i][1] <= 0 || glowArray[i][1] >= 500)
{
glowArray[i][3] *= -1;
}
}
if ( playerArmor <= 0)
{
var playerXPos2 = playerXPos;
var playerYPos2 = playerYPos;
playerYPos = playerRow*tileSize+sizeDiff;
playerXPos = playerCol*tileSize+sizeDiff;
offsetX = playerXPos2 - playerXPos;
offsetY = playerYPos2 - playerYPos;
playerArmor = 100;
}
vehicle1XAcceleration = 0;
for ( t = 0; t < terPoints.length; t++)
{
if ( vehicle1XPos <= t + 1
&& t <= vehicle1XPos + 5
&& vehicle1YPos <= terPoints[t] + 100
&& terPoints[t] <= vehicle1YPos + 5 )
{
vehicle1XSpeed += 0.1*-vehicle1XSpeed;

//control speed

if ( playerArmor < 50 && vehicle1XPos > playerXPos)
{
vehicle1XAcceleration = -0.3;
}
if ( playerArmor < 50 && vehicle1XPos < playerXPos 

// && playerArmor >= 50 

)
{
vehicle1XAcceleration = 0.3;
}
if ( upPressed)
{
vehicle1YSpeed = -1;
vehicle1YSpeed1 = -1;
}
vehicle1XSpeed += vehicle1XAcceleration;
}
}
vehicle1Rotation += 5*vehicle1XSpeed;
vehicle1Rotation12 += 5*vehicle1XSpeed;
vehicle1YSpeed += gravityForce/10;
vehicle1YPos += vehicle1YSpeed;
if ( vehicle1XSpeed >= 5)
{
vehicle1XSpeed = 5;
}
if ( vehicle1XSpeed <= -5 )
{
vehicle1XSpeed = -5;
}
vehicle1XPos += vehicle1XSpeed;
vehicle1YSpeed1 += gravityForce/10;
vehicle1YPos1 += vehicle1YSpeed1;
vehicle1XPos1 += vehicle1XSpeed1;
if ( vehicle1YPos >= 450)
{
vehicle1YPos = 450;
vehicle1YSpeed *= -0.5;
}
if ( vehicle1YPos1 >= 450)
{
vehicle1YPos1 = 450;
vehicle1YSpeed1 *= -0.5;
}
circle.YSpeed += gravityForce/5;
circle.y += circle.YSpeed;
if ( circleRecttouching(circle, rectangle))
{
circle.y = -circle.r+rectangle.y;
circle.YSpeed *= -0.8;
}
vehicle1XPos1 = vehicle1XPos + 50;
//Math.cos(Math.asin(Math.abs(vehicle1YPos-vehicle1YPos1)/50))*50*0;
for ( t = 0; t < terPoints.length; t++)
{
if ( vehicle1XPos <= t + 1
&& t <= vehicle1XPos + 5
&& vehicle1YPos <= terPoints[t] + 100
&& terPoints[t] <= vehicle1YPos + 5 )
{
vehicle1YSpeed *= -0.8;
vehicle1YPos = terPoints[t]- 5;
}
if ( vehicle1XPos1 <= t + 1
&& t <= vehicle1XPos1 + 5
&& vehicle1YPos1 <= terPoints[t] + 100
&& terPoints[t] <= vehicle1YPos1 + 5 )
{
vehicle1YSpeed1 *= -0.8;
vehicle1YPos1 = terPoints[t]- 5;
}
}
stretchspeed += 0.5*-stretchamount;
stretchspeed -= 0.1*stretchspeed;
stretchamount += stretchspeed;
stretchamount += vehicle1YSpeed*2;
stretchspeed2 += 0.5*-stretchamount2;
stretchspeed2 -= 0.1*stretchspeed2;
stretchamount2 += stretchspeed2;
stretchamount2 += vehicle1YSpeed1*2;
var rand1=Math.random();
if (enemies.length < 10 )
{
numberofenemies += 1;
enemies.push([alienshipXPos + 5 + Math.floor(Math.random()*3)*32, alienshipYPos + 70, "sentry", 25, 0, 0, [], 0, 0, 0, "right", "aliensoldier", 0 ]);
}

if (ukeypressed)
{
stealthcount += 1;
}

if (ukeypressed && playerstealth == "uncloaked" && stealthcount >= 10 )
{
playerstealth = "cloaked";
stealthcount = 0;
}
else if (ukeypressed && playerstealth == "cloaked" && stealthcount >= 10 )
{
playerstealth = "uncloaked";
stealthcount = 0;
}
for (i=0; i < rogersounds.length; i++)
{
rogersounds[i].volume = 1;

}


//add new stuff
if (theme1.currentTime==0 || theme1.ended)
{
theme1.currentTime = 0;
theme1.play();
}
theme1.play();

var r1 = 35 + 10-Math.random()*20
var planeRotation1 = r1 *Math.PI/180;
if  (alienguardL == 1.8 && mkeypressed)
{
cannonarray.push([ alienguardX+ 50+15-25, alienguardY+50-25+8, Math.cos(planeRotation1)*20, Math.sin(planeRotation1)*20, r1]);
}


for ( var i = 0; i < guards.length; i++ )
{
var baseCol1 = Math.floor(guards[i][0]/tileSize);
var baseRow1 = Math.floor(guards[i][1]/tileSize);
var colOverlap1 = guards[i][0]%tileSize>sizeDiff;
var rowOverlap1 = guards[i][1]%tileSize>sizeDiff;
if ( verticalnavigation1( guards[i][0], guards[i][1], guards[i][4], guards[i][5] ) === 'verticalnav1' ) 
{
guards[i][1] = baseRow1*tileSize+sizeDiff;
guards[i][5]=0;
guards[i][9] = "onground";
}
else
{
guards[i][9] = "notonground";
}
if ( verticalnavigation2( guards[i][0], guards[i][1], guards[i][4], guards[i][5] ) === 'verticalnav2' ) 
{
guards[i][1] = (baseRow1+1)*tileSize;
guards[i][5] = 0;
}
if ( horizontalnavigation1( guards[i][0], guards[i][1], guards[i][4], guards[i][5] ) === 'horizontalnav1' )
{
guards[i][0]=baseCol1*tileSize;
guards[i][8] = "at wall";
}
else if ( horizontalnavigation2( guards[i][0], guards[i][1], guards[i][4], guards[i][5] ) === 'horizontalnav2' )
{
guards[i][0]=(baseCol1+1)*tileSize;
guards[i][8] ="at wall";
}
else
{
guards[i][8] = "not at wall";
}

if (guards[i][8] === "at wall" && guards[i][9] === "onground")
{
guards[i][5] = -15;
}
else if ( playerYPos < guards[i][1] && guards[i][9] === "onground" && guards[i][2] === "inactivesentry" )
{
guards[i][5] = -10;
}
guards[i][5] += gravityForce1;
guards[i][5] = Math.min(guards[i][5] , maxFallingSpeed);

guards[i][0] += guards[i][4];
guards[i][1] += guards[i][5];

if (squadbehavior === "followplayer")
{

if (playerXPos < guards[i][0]-50)
{
guards[i][4] = -3;
guards[i][10] = "left";
}
else if (playerXPos > guards[i][0]+ 50)
{
guards[i][4] = 3;
guards[i][10] = "right" ;
}
else
{
guards[i][4] = 0;
}

}

if (squadbehavior === "attacking")
{
guards[i][4] = 5;
}
else if (squadbehavior === "retreating")
{
guards[i][4] = -3;
}

}

if (squadbehavior === "tacticalmaneuver" )
{
guards[0][4]  = -0.4;
if( astroguard2L == 0 && mkeypressed)
{
guardlasers.push([ guards[1][0], guards[1][1], -10]);
//playergrenades.push([ guards[2][0], guards[2][1], -8, 5, 100]);

//playergrenades.push([ mechXPos + 5, mechYPos + 50, -8, 5, 100]);

if (mechDirection === "right" )
{

if ( mechXPos2 ==2 || mechXPos2 == 3 || mechXPos2 == 6 || mechXPos2 == 7)
{
playerlasers.push([ mechXPos+60 + 45, mechYPos+30, laserWidth, laserHeight, 15]);
}
else
{
playerlasers.push([ mechXPos+60 + 45, mechYPos+35, laserWidth, laserHeight, 15]);

}


}
if (mechDirection === "left" )
{

if ( mechXPos2 ==2 || mechXPos2 == 3 || mechXPos2 == 6 || mechXPos2 == 7)
{
playerlasers.push([ mechXPos-15 - 45, mechYPos+30, laserWidth, laserHeight, -15]);
}
else 
{
playerlasers.push([ mechXPos-15 - 45, mechYPos+35, laserWidth, laserHeight, -15]);
}

}


}

guards[1][4] = 0;
guards[2][4] = -0.5;
guards[3][4] = -0.5;


guards[4][4] = -0.5;


}


var i, a;

for ( i = 0; i < guards.length; i++ )
{
for ( a = i+1; a < guards.length; a++)
{
var guardstogether = (guards[i][0] <= guards[a][0] + allyWidth
&& guards[a][0] <= guards[i][0] + allyWidth
&& guards[i][1] <= guards[a][1] + allyHeight
&& guards[a][1] <= guards[i][1] + allyHeight );

if ( guards[i][4] < 0 && guards[i][0] >= guards[a][0] &&
guardstogether )
{
//guards[i][0] = guards[a][0] + 43;
guards[i][4] = 0;
}
else if ( guards[i][4] > 0 && guards[i][0] <= guards[a][0] &&
guardstogether )
{
//guards[i][0] = guards[a][0] - 43;
guards[i][4] = 0;
}

}
}

 

for (var i= 0; i< laserexplosions.length; i++)
{
laserexplosions[i][2] += 0.2;

if (Math.floor(laserexplosions[i][2]) >= 9)
{
laserexplosions.splice(i, 1);
}

}

for ( var i= 0; i < glassarray.length; i++)
{

glassarray[i][0] += glassarray[i][4];
glassarray[i][1] += glassarray[i][5];
glassarray[i][2] += glassarray[i][6];

glassarray[i][3] -= 1;
if ( glassarray[i][3] <= 0)
{
glassarray.splice(i, 1);
}

}

if ( jkeypressed )
{
laserexplosions.push([ 100 + Math.random()*100, 50, 0]);


glassalpha = 0;

for ( var i=0; i < 9; i++)
{
var rand = Math.random();
var rand2 = Math.random();

glassarray.push([525 , 69 + Math.floor(10*i), 0, 10, 5 + rand2*5, rand*10+ -5, rand2*50]);
}

var rand = Math.random();
var rand2 = Math.random();

glassarray.push([525 , 69 + Math.floor(10*8) + 5, 0, 10, 10 + rand2*10, rand*10+ -5, rand2*50]);

}

for ( var i = 0; i < warriorlasers.length; i++)
{

if (playerXPos <= warriorlasers[i][0] + 300
&& 550 <= playerXPos + 24
&& playerYPos <= warriorlasers[i][1] + 1
&& warriorlasers[i][1] <= playerYPos + 24)
{

warriorlasers.splice(i, 1);

if (playerShields > 0)
{
playerShields -= 5
}
else if (playerShields <= 0)
{
playerArmor -= 5;
}

}

}

for ( var i=0; i< warriors.length; i++)
{
warriors[i][1] += warriors[i][7];
warriors[i][7] += gravityForce1;
warriors[i][7] = Math.min(warriors[i][7] , maxFallingSpeed);

if (warriors[i][1] >= 190)
{
warriors[i][1] = 190;
}

}


if (allies[1])
{
turretX = allies[1][0];
turretY = allies[1][1]+20;
}

if (turretfirerate >= 14 && mkeypressed)
{
playerlasers.push( [turretX+ 30, turretY-5, laserWidth, laserHeight, 15]);
}

if (enemies.length >= 10)
{

if (enemies[alienroles] )
{

if (enemies[alienroles][11] === "aliensoldier" 
&& alienleaderchosen == 0 )
{
enemies[alienroles][11] = "I'm the leader";
alienleaderchosen = 1;
}
else if ( enemies[alienroles][11] === "aliensoldier" && enemies[alienroles][11] !== "I'm the leader" && alienleaderchosen == 1 )
{
enemies[alienroles][11] = "Search the area!";
}

alienroles+=1;

}
}

if (alienroles >= 10)
{
alienroles = 0;
}



allyspawncount += 1;
if (allies.length < 5 && allyspawncount >= 10)
{
allies.push([Math.floor(Math.random()*3)*30+astroship2XPos + 50, astroship2YPos+12, "sentry", 50, 0, 0, [], 0, 0, 0, "right", 25, 0, 0]);
playrogersound();
allyspawncount = 0;
}

if (aliens.length < 5 && allyspawncount >= 10)
{
aliens.push([Math.floor(Math.random()*3)*30+astroship2XPos + 50, astroship2YPos+50, "sentry", 50, 0, 0, [], 0, 0, 0, "right", 25, 0, 0]);
allyspawncount = 0;
}


 healingprogress+=0.1;
/*

healingparticles.push([alienXPos+12, alienYPos-12*Math.sin(healingprogress)]);
healingparticles2.push([alienXPos+12, alienYPos+12*Math.sin(healingprogress)]);


for ( h=0; h < healingparticles.length; h++)
{


healingparticles[h][0]-=1;


if (healingparticles[h][0] <= playerXPos + 24
&& playerXPos <= healingparticles[h][0] + 3
&& healingparticles[h][1] <= playerYPos + 24
&& playerYPos <= healingparticles[h][1] + 3)
{
healingparticles.splice(h, 1);
}
else if (healingparticles[h][0] < alienXPos -200)
{
healingparticles.splice(h, 1);
}

}

for ( h=0; h < healingparticles2.length; h++)
{

healingparticles2[h][0]-=1;

if (healingparticles2[h][0] <= playerXPos + 24
&& playerXPos <= healingparticles2[h][0] + 3
&& healingparticles2[h][1] <= playerYPos + 24
&& playerYPos <= healingparticles2[h][1] + 3)
{
healingparticles2.splice(h, 1);
}
else if (healingparticles2[h][0] < alienXPos -200)
{
healingparticles2.splice(h, 1);
}

}

*/


//playerXPos = (vehicle1XPos + vehicle1XPos1)/2 -24;
//playerYPos = (vehicle1YPos + vehicle1YPos1)/2 -24;
//plane3XPos = playerXPos;
//plane3YPos = playerYPos - 10;

for (i=0; i < lasersounds.length; i++)
{
lasersounds[i].volume = 0.1;
if (lasersounds[i].currentTime >= 1)
{
lasersounds[i].pause();
lasersounds[i].currentTime = 0;
}
}

for (i=0; i < astrowalksounds.length; i++)
{

if (rightPressed === false && leftPressed === false)
{
astrowalksounds[i].pause();
astrowalksounds[i].currentTime = 0;
}
else 
{
astrowalksounds[currSound5].play();
}

}

for (i=0; i < landsounds.length; i++)
{
landsounds[i].volume = 0.05;
if (landsounds[i].currentTime >= 1.5)
{
landsounds[i].pause();
landsounds[i].currentTime = 0;
}
}

for (i=0; i < energycubesounds.length; i++)
{
energycubesounds[i].volume = 0.1;
if (energycubesounds[i].currentTime >= 0.8)
{
energycubesounds[i].pause();
energycubesounds[i].currentTime = 0;
}
}


if (playerwalk>= 7)
{
playerwalk = 0;
}

for (i=0; i < allies.length; i++)
{
if (allies[i][4] == 3 || allies[i][4] == -3)
{
allies[i][13] += 0.3;
}

if (allies[i][13] >= 7)
{
allies[i][13] = 0;
}
}

for (i=0; i < aliens.length; i++)
{
if (aliens[i][4] == 3 || aliens[i][4] == -3)
{
aliens[i][13] += 0.3;
}

if (aliens[i][13] >= 7)
{
aliens[i][13] = 0;
}
}

alienshipXPos += alienshipXSpeed;

if ( alienshipXPos >= 2000 && alienshipXSpeed > 0 )
{
alienshipXSpeed *= -1;
}
else if( alienshipXPos <= 1800 && alienshipXSpeed < 0 )
{
alienshipXSpeed *= -1;
}

astroship2XPos += astroship2XSpeed;

if ( astroship2XPos >= 3000 && astroship2XSpeed > 0 )
{
astroship2XSpeed *= -1;
}
else if( astroship2XPos <= 2000 && astroship2XSpeed < 0 )
{
astroship2XSpeed *= -1;
}


/*
if ( theme2.currentTime == 0)
{

theme2.play();
}
if (theme2.ended)
{
//theme2.currentTime = 0;
//theme1.play();
}
if (theme1.ended)
{
theme2.currentTime = 0;
}
*/

//if (tformerssong.currentTime == 0 || tformerssong.ended)
//{
//tformerssong.play();
//}


if (mkeypressed && volumestuff > -0.01)
{
if (volumestuff > 0.01)
{
volumestuff -= 0.01;
}
else if (volumestuff > 0)
{
volumestuff = 0;
}

}
if (skeypressed && volumestuff < 0.9 )
{
volumestuff += 0.01;
}


//theme1.volume = volumestuff*0 + 0.5;
//theme2.volume = volumestuff*0 + 0.5;

for (h=0; h < shipparts.length; h++)
{
var x1 = shipparts[h][0]+ alienshipXPos;
var x2 = shipparts[h][1]+ alienshipYPos;

if (playerXPos <= x1 + shipparts[h][2] 
&& x1 <= playerXPos +24
&& playerYPos <= x2 + shipparts[h][3] 
&& x2 <= playerYPos + 24)
{
if (playerYPos + 12 > x2+(shipparts[h][3]/2) && 
playerXPos+12>x1 && playerXPos+12<x1+shipparts[h][2])
{
playerYPos = x2+shipparts[h][3];
playerYSpeed *= -1;
}
if (playerYPos + 12 < x2+(shipparts[h][3]/2) && 
playerXPos+12>x1 && playerXPos+12<x1+shipparts[h][2])
{
if (playerYSpeed > 2)
{

}
playerYPos = x2-24;
playerYSpeed = 0;
playerXPos += alienshipXSpeed;
}

if ( playerXSpeed < 0 && playerXPos + 12 > x1+(shipparts[h][2]/2) && 
playerYPos+12>x2 && playerYPos+12<x2+shipparts[h][3])
{
playerXPos = x1;
playerXSpeed =0;
}

if ( playerXSpeed > 0 && playerXPos + 12 < x1+(shipparts[h][2]/2) && 
playerYPos+12>x2 && playerYPos+12<x2+shipparts[h][3])
{
playerXPos = x1-24;
playerXSpeed = 0;
}

}


}


for (h=0; h < ship2parts.length; h++)
{
var x1 = ship2parts[h][0]+ astroship2XPos;
var x2 = ship2parts[h][1]+ astroship2YPos;

if (playerXPos <= x1 + ship2parts[h][2] 
&& x1 <= playerXPos +24
&& playerYPos <= x2 + ship2parts[h][3] 
&& x2 <= playerYPos + 24)
{
if (playerYPos + 12 > x2+(ship2parts[h][3]/2) && 
playerXPos+12>x1 && playerXPos+12<x1+ship2parts[h][2])
{
playerYPos = x2+ship2parts[h][3];
playerYSpeed *= -1;
}
if (playerYPos + 12 < x2+(ship2parts[h][3]/2) && 
playerXPos+12>x1 && playerXPos+12<x1+ship2parts[h][2])
{
if (playerYSpeed > 2)
{

}
playerYPos = x2-24;
playerYSpeed = 0;
playerXPos += astroship2XSpeed;
}

if ( playerXSpeed < 0 && playerXPos + 12 > x1+(ship2parts[h][2]/2) && 
playerYPos+12>x2 && playerYPos+12<x2+ship2parts[h][3])
{
playerXPos = x1;
playerXSpeed =0;
}

if ( playerXSpeed > 0 && playerXPos + 12 < x1+(ship2parts[h][2]/2) && 
playerYPos+12>x2 && playerYPos+12<x2+ship2parts[h][3])
{
playerXPos = x1-24;
playerXSpeed = 0;
}

}


}


for (a=0; a < allies.length; a++)
{

for (h=0; h < ship2parts.length; h++)
{
var x1 = ship2parts[h][0]+ astroship2XPos;
var x2 = ship2parts[h][1]+ astroship2YPos;

if (allies[a][0] <= x1 + ship2parts[h][2] 
&& x1 <= allies[a][0] +24
&& allies[a][1] <= x2 + ship2parts[h][3] 
&& x2 <= allies[a][1] + 24)
{
if (allies[a][1] + 12 > x2+(ship2parts[h][3]/2) && 
allies[a][0]+12>x1 && allies[a][0]+12<x1+ship2parts[h][2])
{
allies[a][1] = x2+ship2parts[h][3];
allies[a][5] *= -1;
}
if (allies[a][1] + 12 < x2+(ship2parts[h][3]/2) && 
allies[a][0]+12>x1 && allies[a][0]+12<x1+ship2parts[h][2])
{

allies[a][1] = x2-24;
allies[a][5] = 0;
allies[a][0] += astroship2XSpeed;
}

if ( allies[a][4] < 0 && allies[a][0] + 12 > x1+(ship2parts[h][2]/2) && 
allies[a][1]+12>x2 && allies[a][1]+12<x2+ship2parts[h][3])
{
allies[a][0] = x1;
allies[a][4] =0;
}

if ( allies[a][4] > 0 && allies[a][0] + 12 < x1+(ship2parts[h][2]/2) && 
allies[a][1]+12>x2 && allies[a][1]+12<x2+ship2parts[h][3])
{
allies[a][0] = x1-24;
allies[a][4] = 0;
}

}


}
}

for (a =0; a< enemies.length; a++)
{

if (enemies[a][11] === "I'm the leader" && beaconarray.length == 0)
{
beaconarray.push([enemies[a][0], enemies[a][1] ]);
}

}



//
for ( var i = 0; i < playergrenades.length; i++)
{
playergrenades[i][2] = Math.max(playergrenades[i][2], -10);
playergrenades[i][0] += playergrenades[i][3];
playergrenades[i][1] += playergrenades[i][2];
playergrenades[i][2] += gravityForce;
playergrenades[i][4] -= 1;
var grenadeX = Math.floor(playergrenades[i][0]/tileSize);
var grenadeY = Math.floor(playergrenades[i][1]/tileSize);
var overlap1 = playergrenades[i][0]%tileSize > 32 - 10;
var overlap2 = playergrenades[i][1]%tileSize > 32 - 10;
if (playergrenades[i][6] == "bounce" )
{
//playergrenades[i][2] *= -0.9;
//playergrenades[i][3] *= -0.9;
if(playergrenades[i][2] > 0){
if (playergrenades[i][1] >= 445)
{
playergrenades[i][1] = grenadeY*tileSize+ 20;
playergrenades[i][2] *= -0.6;
playergrenades[i][3] *= 0.5;
}
else if((level[grenadeY+1][grenadeX] && !level[grenadeY][grenadeX] && overlap2) || (level[grenadeY+1][grenadeX+1] && !level[grenadeY][grenadeX+1] && overlap1 && overlap2) ){
playergrenades[i][1] = grenadeY*tileSize+ 20;
playergrenades[i][2] *= -0.6;
playergrenades[i][3] *= 0.5;
}
}
if(playergrenades[i][2] < 0){
if ( playergrenades[i][1] >= 445)
{
playergrenades[i][1] -= 60;
}
else if((!level[grenadeY+1][grenadeX] && level[grenadeY][grenadeX]) || (!level[grenadeY+1][grenadeX+1] && level[grenadeY][grenadeX+1] && overlap1)){
playergrenades[i][1] = (grenadeY+1)*tileSize;
playergrenades[i][2] *= - 0.6;
playergrenades[i][3] *= 0.5;
}
}
if(playergrenades[i][3] <0)
{
if ( playergrenades[i][1] >= 445)
{
playergrenades[i][1] -= 60;
}
else if(( level[grenadeY][grenadeX]) || (!level[grenadeY+1][grenadeX+1] && level[grenadeY+1][grenadeX] && overlap2) || (playergrenades[i][0] <= 0))
{
playergrenades[i][3] *= -1;
//playergrenades[i][0] = (grenadeX+1)*tileSize;
}
}
if(playergrenades[i][3] > 0){
if (playergrenades[i][0] >= 3000)
{
playergrenades[i][3] *= -1;
}
else if (level[grenadeY+1] === undefined)
{
playergrenades[i][1] -= 60;
}
else if((level[grenadeY][grenadeX+1] && !level[grenadeY][grenadeX] && overlap1) || (level[grenadeY+1][grenadeX+1] && !level[grenadeY+1][grenadeX] && overlap2 && overlap1)){
playergrenades[i][3] *= -1;
//playergrenades[i][0] = grenadeX*tileSize+20;
}
}
}
if (level[grenadeY][grenadeX] && !playergrenades[i][6] )
{
playergrenades[i][2] = 0;
playergrenades[i][3] = 0;
}
if (playergrenades[i][4] <= 0 )
{
hitarray3.push([playergrenades[i][0]+5, playergrenades[i][1]+5, 10, 2]);


for (var a = 0; a < enemies.length; a++)
{


if ( enemies[a][0] <= playergrenades[i][0] + 45
&& playergrenades[i][0] -45 <= enemies[a][0] + 32
&& enemies[a][1] <= playergrenades[i][1] + 45
&& playergrenades[i][1] -45 <= enemies[a][1] + 32 )
{

if ( (enemies[a][0] - playergrenades[i][0]) > 0)
{
enemies[a][4] += 15;
}
if ( (enemies[a][0] - playergrenades[i][0]) <= 0)
{
enemies[a][4] += -15;
}

enemies[a][3] -= 10;
enemies[a][5] = -15; 




}
}

for ( var w=0; a < warriors.length; a++)
{
if ( warriors[w][0] <= playergrenades[i][0] + 45
&& playergrenades[i][0] -45 <= warriors[w][0] + 30
&& warriors[w][1] <= playergrenades[i][1] + 45
&& playergrenades[i][1] -45 <= warriors[w][1] + 50 )
{


warriors[w][2] = "hit";
warriors[w][7] = -10;

}

}

for ( g=0; g< 20; g++)
{
sparkarray.push([playergrenades[i][0] + 10*Math.random(), playergrenades[i][1], Math.random()*15+-7.5, -Math.random()*15 +(-7.5), 10, 3, "cyan"]);
}

playergrenades.splice(i, 1);
}
}
// rendering level
renderLevel();
// update the game in about 1/60 seconds
requestAnimFrame(function() {
updateGame();
});
}
updateGame();
})();
</script>
</html>

